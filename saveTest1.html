<!DOCTYPE html>
<html lang="vi" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Lô Sản Phẩm</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .app-container {
            width: 100%;
            max-width: 24rem;
            height: 100vh;
        }
        .form-element {
            min-height: 2.75rem; 
        }
        .scanner-line {
            position: absolute;
            top: 0; left: 0; right: 0; height: 3px;
            background: rgba(13, 110, 253, 0.7);
            box-shadow: 0 0 10px rgba(13, 110, 253, 0.7);
            animation: scan 2s infinite linear;
        }
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        /* Tùy chỉnh thanh cuộn */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #212529; }
        ::-webkit-scrollbar-thumb { background: #495057; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6c757d; }

        /* Nút chọn kiểu Segmented Control */
        .segmented-control-group {
            padding: 4px;
            background-color: var(--bs-body-bg);
            border-radius: 999px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.25);
        }
        .segmented-control-group .btn {
            border: none; background: none; color: var(--bs-secondary-color);
            font-weight: 600; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-radius: 999px; padding-top: 0.55rem; padding-bottom: 0.55rem;
            box-shadow: none !important;
        }
        .segmented-control-group .btn-check:checked + .btn {
            background-color: var(--bs-tertiary-bg); color: var(--bs-body-color);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2) !important;
        }
        .segmented-control-group .btn:hover:not(.active) { color: var(--bs-body-color); }
        
        /* Styles for Identification Screen */
         .scanner-box {
            position: relative; width: 100%; max-width: 280px; padding-top: 100%; /* Aspect ratio 1:1 */
        }
        .scanner-box::before, .scanner-box::after, .scanner-box .corner-top-right, .scanner-box .corner-bottom-left, .scanner-box .corner-bottom-right {
            content: ''; position: absolute; width: 30px; height: 30px; border-color: #0dcaf0; border-style: solid; /* Bootstrap info color */
        }
        .scanner-box::before { top: -2px; left: -2px; border-width: 4px 0 0 4px; }
        .scanner-box::after { top: -2px; right: -2px; border-width: 4px 4px 0 0; }
        .scanner-box .corner-bottom-left { bottom: -2px; left: -2px; border-width: 0 0 4px 4px; }
        .scanner-box .corner-bottom-right { bottom: -2px; right: -2px; border-width: 0 4px 4px 0; }
        .scanner-box .scanner-content { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
        #id-list-details details { border-left: 1px solid var(--bs-border-color); margin-left: 0.5rem; }
        #id-list-details summary { cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        #id-list-details summary:hover { background-color: var(--bs-tertiary-bg); }
        #id-list-details .item-code { padding: 0.25rem 0.5rem 0.25rem 1.5rem; }
    </style>
</head>
<body class="bg-dark d-flex justify-content-center align-items-center min-vh-100">

    <div class="app-container bg-body-secondary shadow-lg rounded-4 d-flex flex-column position-relative overflow-hidden">
        
        <!-- ===== MÀN HÌNH DANH SÁCH LÔ SẢN PHẨM ===== -->
        <div id="list-screen" class="d-flex flex-column h-100">
            <header class="bg-dark shadow-sm sticky-top z-1">
                <div class="px-3 py-3">
                     <h1 class="fs-5 fw-bold text-light text-center w-100">Quản Lý Lô Sản Phẩm</h1>
                </div>
            </header>
            <div class="p-3 bg-dark border-bottom border-secondary">
                <div class="position-relative">
                    <div class="position-absolute top-50 start-0 translate-middle-y ps-3 pe-none">
                        <svg class="h-5 w-5 text-secondary" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/></svg>
                    </div>
                    <input type="text" id="search-input" class="form-control rounded-pill ps-5" placeholder="Tìm theo mã lô, tên sản phẩm...">
                </div>
            </div>
            <main class="flex-grow-1 overflow-y-auto p-3 bg-dark">
                <div id="batch-list-container" class="d-flex flex-column gap-3"></div>
                <p id="no-results" class="text-center text-secondary d-none">Không tìm thấy lô sản phẩm nào.</p>
            </main>
            <button id="add-new-button" class="btn btn-primary btn-lg rounded-circle position-absolute bottom-0 end-0 m-3 z-2 d-flex justify-content-center align-items-center" style="width: 56px; height: 56px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/></svg>
            </button>
        </div>

        <!-- ===== MÀN HÌNH FORM (Thêm & Sửa Lô) ===== -->
        <div id="form-screen" class="d-none d-flex flex-column h-100">
             <header class="bg-dark shadow-sm z-1 flex-shrink-0">
                <div class="px-3 py-3 d-flex align-items-center">
                    <button id="back-to-list-button" class="btn btn-link text-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/></svg>
                    </button>
                    <h1 id="form-title" class="fs-5 fw-bold text-light text-center flex-grow-1"></h1>
                    <div style="width: 40px;"></div>
                </div>
            </header>
            <main class="flex-grow-1 overflow-y-auto p-4 bg-dark">
                <form id="batch-declaration-form" class="d-flex flex-column gap-4">
                    <div class="btn-group w-100 segmented-control-group" role="group">
                        <input type="radio" class="btn-check" name="declaration_type" id="type_lsx" value="lsx" autocomplete="off" checked>
                        <label class="btn" for="type_lsx">Theo Lệnh Sản Xuất</label>
                        <input type="radio" class="btn-check" name="declaration_type" id="type_bom" value="bom" autocomplete="off">
                        <label class="btn" for="type_bom">Theo BOM</label>
                    </div>
                    <div id="lsx-selector-container">
                        <label for="production-order" class="form-label">Chọn Lệnh sản xuất (LSX)</label>
                        <select id="production-order" class="form-select form-element"></select>
                    </div>
                    <div id="bom-selector-container" class="d-none">
                        <label for="bom-select" class="form-label">Chọn BOM sản phẩm</label>
                        <select id="bom-select" class="form-select form-element"></select>
                    </div>
                    <div class="row g-3">
                        <div class="col-6"><label for="batch-code" class="form-label">Mã lô</label><input type="text" id="batch-code" class="form-control form-element" readonly></div>
                        <div class="col-6"><label for="batch-creation-date" class="form-label">Ngày tạo</label><input type="date" id="batch-creation-date" class="form-control form-element"></div>
                    </div>
                     <div class="row g-3">
                        <div class="col-6"><label for="product-code" class="form-label">Mã SP</label><input type="text" id="product-code" class="form-control form-element" readonly></div>
                        <div class="col-6"><label for="product-name" class="form-label">Tên SP</label><input type="text" id="product-name" class="form-control form-element" readonly></div>
                    </div>
                    <div><label for="bom-display" class="form-label">BOM sản xuất</label><input type="text" id="bom-display" class="form-control form-element" readonly></div>
                    <div><label for="specifications" class="form-label">Thông số kỹ thuật</label><textarea id="specifications" rows="3" class="form-control" readonly></textarea></div>
                    <div class="row g-3">
                        <div class="col-6"><label for="planned-quantity" class="form-label">SL kế hoạch</label><input type="number" id="planned-quantity" class="form-control form-element" readonly></div>
                        <div class="col-6"><label for="actual-quantity" class="form-label">SL thực tế</label><input type="number" id="actual-quantity" class="form-control form-element" min="1" required></div>
                    </div>
                    <div class="row g-3">
                         <div class="col-6"><label for="unit" class="form-label">ĐVT SP</label><input type="text" id="unit" class="form-control form-element" readonly></div>
                         <div class="col-6"><label for="batch-unit" class="form-label">ĐVT Lô</label><select id="batch-unit" class="form-select form-element"><option>Thùng</option><option>Hộp</option><option>Pallet</option><option>Container</option></select></div>
                         <div class="col-6"><label for="warranty" class="form-label">Bảo hành</label><input type="text" id="warranty" class="form-control form-element" readonly></div>
                         <div class="col-6"><label for="status" class="form-label">Trạng thái</label><select id="status" class="form-select form-element"><option>Mới sản xuất</option><option>Đã qua KCS</option><option>Sẵn sàng nhập kho</option><option>Đã hủy</option></select></div>
                     </div>
                </form>
            </main>
            <footer class="p-3 bg-dark border-top border-secondary flex-shrink-0">
                 <button type="submit" id="form-submit-button" form="batch-declaration-form" class="btn btn-primary btn-lg w-100 fw-bold shadow"></button>
            </footer>
        </div>

        <!-- ===== MÀN HÌNH ĐỊNH DANH SẢN PHẨM (MERGED) ===== -->
        <div id="product-id-screen" class="d-none d-flex flex-column h-100">
            <header class="bg-dark shadow-sm z-1 flex-shrink-0 p-3 d-flex align-items-center">
                <button id="back-to-list-from-details-button" class="btn btn-link text-secondary p-0 me-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/></svg>
                </button>
                <h1 id="product-id-title" class="fs-5 fw-bold text-light text-center flex-grow-1 m-0">Định Danh Sản Phẩm</h1>
                <div style="width: 40px;"></div>
            </header>

            <main class="flex-grow-1 overflow-y-auto p-3 p-md-4">
                <div id="batch-info-container" class="alert alert-primary p-3 mb-4">
                     <div class="d-flex justify-content-between align-items-center small"><span class="text-body-secondary">Sản phẩm:</span><span id="info-product-name" class="fw-bold text-light text-end"></span></div>
                     <div class="d-flex justify-content-between align-items-center small mt-2"><span class="text-body-secondary">Đơn vị lô:</span><span id="info-unit" class="fw-bold badge bg-primary px-2 py-1"></span></div>
                     <div class="d-flex justify-content-between align-items-center small mt-2"><span class="text-body-secondary">Tổng số SP trong lô:</span><span id="info-total-quantity" class="fw-bold text-light"></span></div>
                     <div class="d-flex justify-content-between align-items-center small mt-2"><span class="text-body-secondary">Đã định danh (SP):</span><span id="info-identified-quantity" class="fw-bold text-success"></span></div>
                     <div class="d-flex justify-content-between align-items-center small mt-2"><span class="text-body-secondary">Cần quét còn lại (SP):</span><span id="info-remaining-quantity" class="fw-bolder text-danger fs-6 m-0"></span></div>
                </div>
                 <div id="packaging-declaration-container" class="d-none border rounded p-3 mb-4 bg-body-tertiary">
                    <h3 class="h6 fw-bold text-light">Khai báo cấu trúc đóng gói</h3>
                    <div class="row mt-3 g-2">
                        <div id="declaration-layer-level" class="col-6 mb-2"><label for="items-per-layer" class="d-block small fw-medium text-body-secondary mb-1">Số SP / Lớp</label><input type="number" id="items-per-layer" class="form-control text-center"></div>
                        <div id="declaration-carton-level" class="col-6 mb-2"><label for="layers-per-carton" class="d-block small fw-medium text-body-secondary mb-1">Số Lớp / Thùng</label><input type="number" id="layers-per-carton" class="form-control text-center"></div>
                        <div id="declaration-pallet-level" class="col-6 mb-2"><label for="cartons-per-pallet" class="d-block small fw-medium text-body-secondary mb-1">Số Thùng / Pallet</label><input type="number" id="cartons-per-pallet" class="form-control text-center"></div>
                        <div id="declaration-container-level" class="col-6 mb-2"><label for="pallets-per-container" class="d-block small fw-medium text-body-secondary mb-1">Số Pallet / Cont.</label><input type="number" id="pallets-per-container" class="form-control text-center"></div>
                    </div>
                    <div class="mt-3 p-2 bg-dark border rounded">
                        <p class="small text-body-secondary m-0 d-none" id="calc-carton-row">Tổng SP / Thùng: <strong id="calc-items-per-carton" class="text-light">0</strong></p>
                        <p class="small text-body-secondary m-0 d-none" id="calc-pallet-row">Tổng SP / Pallet: <strong id="calc-items-per-pallet" class="text-light">0</strong></p>
                        <p class="small text-body-secondary m-0 d-none" id="calc-container-row">Tổng SP / Cont.: <strong id="calc-items-per-container" class="text-light">0</strong></p>
                        <hr class="my-2 d-none" id="calc-divider">
                        <p class="small text-body-secondary m-0 d-none" id="calc-total-cartons-row">Tổng số Thùng (dự kiến): <strong id="calc-total-cartons" class="text-primary fw-bold">0</strong></p>
                        <p class="small text-body-secondary m-0 d-none" id="calc-total-pallets-row">Tổng số Pallet (dự kiến): <strong id="calc-total-pallets" class="text-primary fw-bold">0</strong></p>
                        <p class="small text-body-secondary m-0 d-none" id="calc-total-containers-row">Tổng số Cont. (dự kiến): <strong id="calc-total-containers" class="text-primary fw-bold">0</strong></p>
                    </div>
                    <div id="remainder-alert" class="alert alert-warning mt-2 p-2 small d-none" role="alert">
                        <strong class="d-block">Lưu ý:</strong> <span id="remainder-text"></span>
                    </div>
                </div>
                 <div id="scan-progress-container" class="d-none alert alert-warning p-3 mb-4">
                     <h3 class="h6 fw-bold text-dark">Tiến độ quét hiện tại</h3>
                     <div class="row text-center small mt-2">
                         <div id="progress-pallet" class="col d-none"><p class="text-muted m-0">Pallet</p><p class="fw-bold text-warning-dark m-0"></p></div>
                         <div id="progress-carton" class="col d-none"><p class="text-muted m-0">Thùng</p><p class="fw-bold text-warning-dark m-0"></p></div>
                         <div id="progress-layer" class="col d-none"><p class="text-muted m-0">Lớp</p><p class="fw-bold text-warning-dark m-0"></p></div>
                     </div>
                </div>
                <div class="mb-4">
                    <label class="d-block fw-medium text-body-secondary mb-2 small">Quét mã sản phẩm</label>
                    <button type="button" id="start-scan-button" class="btn btn-light btn-lg w-100 fw-bold shadow" data-bs-toggle="modal" data-bs-target="#id-scan-modal">Bắt Đầu Quét</button>
                </div>
                <div id="results-container">
                    <h2 class="h6 fw-bold text-body-secondary">Sản Phẩm Đã Quét (<span id="scan-count">0</span>)</h2>
                    <div id="id-list-details" class="bg-dark p-3 rounded border" style="max-height: 200px; overflow-y: auto;">
                        <p class="text-center text-secondary small m-0">Chưa có sản phẩm nào được quét.</p>
                    </div>
                </div>
            </main>
            <footer class="p-3 bg-dark border-top border-secondary flex-shrink-0">
                 <button type="button" id="save-identities-button" class="btn btn-primary btn-lg w-100 fw-bold shadow">Lưu Thông Tin</button>
            </footer>
        </div>
        
        <!-- ===== MODALS & TOASTS ===== -->
        <div id="delete-modal" class="modal fade" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-secondary bg-dark-subtle">
                    <div class="modal-body text-center p-4">
                        <h3 class="fs-5 fw-bold text-light">Xác nhận Xóa</h3>
                        <p class="small text-body-secondary mt-2">Bạn có chắc chắn muốn xóa lô <b id="batch-code-to-delete" class="text-warning"></b>? Hành động này không thể hoàn tác.</p>
                        <div class="mt-4 d-flex justify-content-center gap-3">
                            <button type="button" class="btn btn-secondary fw-semibold" data-bs-dismiss="modal">Hủy bỏ</button>
                            <button type="button" id="confirm-delete-button" class="btn btn-danger fw-semibold">Xác nhận</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Scan Modal for Identification Screen -->
        <div class="modal fade" id="id-scan-modal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content bg-transparent border-0">
                    <div class="modal-body text-center text-white">
                        <div class="scanner-box mx-auto">
                            <div class="corner-bottom-left"></div>
                            <div class="corner-bottom-right"></div>
                            <div class="scanner-content">
                                <div class="scanner-line"></div>
                                <p class="position-absolute w-100 text-center text-white small bg-dark p-1" style="top: 1rem; --bs-bg-opacity: .5;">Hướng camera vào mã QR</p>
                            </div>
                        </div>
                        <p class="mt-4 h5">Đã quét: <span id="modal-scan-count" class="fw-bold text-success">0</span></p>
                        <button id="simulate-scan-button" class="btn btn-success fw-bold py-2 px-4 rounded mt-2">Quét mã giả lập</button>
                        <button type="button" class="btn btn-link text-white-50 mt-4" data-bs-dismiss="modal">Dừng Quét</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container position-fixed bottom-0 start-50 translate-middle-x p-3">
            <div id="app-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto" id="toast-title">Thông báo</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toast-body"></div>
            </div>
        </div>

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DỮ LIỆU MẪU (MOCK DATA) ---
        const generateScannedItems = (count, prefix) => Array.from({ length: count }, (_, i) => `${prefix}-item-${String(i + 1).padStart(4,'0')}`);
        let mockBatches = [
            { batchCode: 'LSP-250911-001', productCode: 'SP-CPU-I9', productName: 'CPU Intel Core i9', bomId: 'BOM_CPU_I9_V1.5', lsx: 'LSX-0987', creationDate: '2025-09-11', status: 'Sẵn sàng nhập kho', active: 0,
              // Identification Data
              quantity: 50000, unit: 'Cái', batchUnit: 'Container', identifiedQuantity: 0, scannedData: {}, palletsPerContainer: 10, cartonsPerPallet: 25, layersPerCarton: 10, itemsPerLayer: 20 },
            { batchCode: 'LSP-250911-002', productCode: 'SP-RAM-DDR5', productName: 'RAM DDR5 16GB', bomId: 'BOM_RAM_DDR5_V2.1', lsx: 'LSX-0988', creationDate: '2025-09-11', status: 'Mới sản xuất', active: 0,
              // Identification Data
              quantity: 482, unit: 'Thanh', batchUnit: 'Thùng', identifiedQuantity: 22, scannedData: {"pallet_1":{"carton_1":{"layer_1": generateScannedItems(20, "P1-C1-L1"), "layer_2": generateScannedItems(2, "P1-C1-L2")}}}, palletsPerContainer: null, cartonsPerPallet: null, layersPerCarton: 5, itemsPerLayer: 20 },
            { batchCode: 'LSP-250910-001', productCode: 'SP-SSD-1TB', productName: 'SSD NVMe 1TB', bomId: 'BOM_SSD_NVME_V4.0', lsx: 'LSX-0989', creationDate: '2025-09-10', status: 'Đã qua KCS', active: 0,
              // Identification Data
              quantity: 120, unit: 'Ổ', batchUnit: 'Pallet', identifiedQuantity: 0, scannedData: {}, palletsPerContainer: null, cartonsPerPallet: 3, layersPerCarton: 4, itemsPerLayer: 10 },
            { batchCode: 'LSP-250910-002', productCode: 'SP-CPU-I9', productName: 'CPU Intel Core i9', bomId: 'BOM_CPU_I9_V1.5', lsx: 'LSX-0987', creationDate: '2025-09-10', status: 'Đã hủy', active: 0,
              // Identification Data
              quantity: 50, unit: 'Cái', batchUnit: 'Hộp', identifiedQuantity: 0, scannedData: {}, palletsPerContainer: null, cartonsPerPallet: null, layersPerCarton: null, itemsPerLayer: null },
        ];
        const productionOrders = [
            { id: 'LSX-0987', productCode: 'SP-CPU-I9', productName: 'CPU Intel Core i9', bomId: 'BOM_CPU_I9_V1.5', specs: '14 nhân, 20 luồng', quantity: 100, unit: 'Cái', warranty: '36 tháng' },
            { id: 'LSX-0988', productCode: 'SP-RAM-DDR5', productName: 'RAM DDR5 16GB', bomId: 'BOM_RAM_DDR5_V2.1', specs: 'Kingston Fury, Bus 5200MHz', quantity: 500, unit: 'Thanh', warranty: '24 tháng' },
            { id: 'LSX-0989', productCode: 'SP-SSD-1TB', productName: 'SSD NVMe 1TB', bomId: 'BOM_SSD_NVME_V4.0', specs: 'Samsung 980 Pro', quantity: 250, unit: 'Ổ', warranty: '60 tháng' }
        ];
        const boms = [
            { id: 'BOM_CPU_I9_V1.5', productCode: 'SP-CPU-I9', productName: 'CPU Intel Core i9', specs: '14 nhân, 20 luồng', unit: 'Cái', warranty: '36 tháng' },
            { id: 'BOM_RAM_DDR5_V2.1', productCode: 'SP-RAM-DDR5', productName: 'RAM DDR5 16GB', specs: 'Kingston Fury, Bus 5200MHz', unit: 'Thanh', warranty: '24 tháng' },
            { id: 'BOM_SSD_NVME_V4.0', productCode: 'SP-SSD-1TB', productName: 'SSD NVMe 1TB', specs: 'Samsung 980 Pro', unit: 'Ổ', warranty: '60 tháng' }
        ];

        // --- Lấy các phần tử DOM ---
        const getDomElements = () => ({
            listScreen: document.getElementById('list-screen'),
            formScreen: document.getElementById('form-screen'),
            productIdScreen: document.getElementById('product-id-screen'),
            batchListContainer: document.getElementById('batch-list-container'),
            searchInput: document.getElementById('search-input'),
            noResults: document.getElementById('no-results'),
            addNewButton: document.getElementById('add-new-button'),
            backToListButton: document.getElementById('back-to-list-button'),
            backToListFromDetailsButton: document.getElementById('back-to-list-from-details-button'),
            form: document.getElementById('batch-declaration-form'),
            formTitle: document.getElementById('form-title'),
            formSubmitButton: document.getElementById('form-submit-button'),
            // Delete Modal
            deleteModalEl: document.getElementById('delete-modal'),
            batchCodeToDelete: document.getElementById('batch-code-to-delete'),
            confirmDeleteButton: document.getElementById('confirm-delete-button'),
            // Form fields
            declarationTypeRadios: document.querySelectorAll('input[name="declaration_type"]'),
            lsxSelectorContainer: document.getElementById('lsx-selector-container'),
            bomSelectorContainer: document.getElementById('bom-selector-container'),
            productionOrderSelect: document.getElementById('production-order'),
            bomSelect: document.getElementById('bom-select'),
            batchCode: document.getElementById('batch-code'),
            batchCreationDate: document.getElementById('batch-creation-date'),
            productCode: document.getElementById('product-code'),
            productName: document.getElementById('product-name'),
            bomDisplay: document.getElementById('bom-display'),
            specifications: document.getElementById('specifications'),
            plannedQuantity: document.getElementById('planned-quantity'),
            actualQuantity: document.getElementById('actual-quantity'),
            unit: document.getElementById('unit'),
            batchUnit: document.getElementById('batch-unit'),
            warranty: document.getElementById('warranty'),
            status: document.getElementById('status'),
            // Product ID Screen
            productIdTitle: document.getElementById('product-id-title'),
            batchInfoContainer: document.getElementById('batch-info-container'),
            packagingContainer: document.getElementById('packaging-declaration-container'),
            infoProductName: document.getElementById('info-product-name'),
            infoUnit: document.getElementById('info-unit'),
            infoTotalQuantity: document.getElementById('info-total-quantity'),
            infoIdentifiedQuantity: document.getElementById('info-identified-quantity'),
            infoRemainingQuantity: document.getElementById('info-remaining-quantity'),
            idListDetails: document.getElementById('id-list-details'),
            scanCount: document.getElementById('scan-count'),
            saveIdentitiesButton: document.getElementById('save-identities-button'),
            scanProgressContainer: document.getElementById('scan-progress-container'),
            progress: {
                pallet: document.getElementById('progress-pallet'),
                carton: document.getElementById('progress-carton'),
                layer: document.getElementById('progress-layer'),
            },
            inputs: {
                palletsPerContainer: document.getElementById('pallets-per-container'),
                cartonsPerPallet: document.getElementById('cartons-per-pallet'),
                layersPerCarton: document.getElementById('layers-per-carton'),
                itemsPerLayer: document.getElementById('items-per-layer'),
            },
            // Scan Modal for ID
            idScanModalEl: document.getElementById('id-scan-modal'),
            modalScanCount: document.getElementById('modal-scan-count'),
            simulateScanButton: document.getElementById('simulate-scan-button'),
            startScanButton: document.getElementById('start-scan-button'),
            // Toast
            toastEl: document.getElementById('app-toast'),
            toastTitle: document.getElementById('toast-title'),
            toastBody: document.getElementById('toast-body'),
        });
        const dom = getDomElements();

        // --- Biến trạng thái ---
        let currentScreen = 'list';
        let currentFormMode = 'add';
        let editingBatchCode = null;
        let batchCodeToDeleteState = null;
        let openSwipeContainer = null;
        let deleteModal, idScanModal, appToast;
        
        // --- State for Identification Screen ---
        let sessionScannedData = {};
        let sessionScannedCount = 0;
        let currentScanIndices = { pallet: 1, carton: 1, layer: 1 };
        let currentIdBatch = null;

        // --- CÁC HÀM XỬ LÝ CHUNG ---
        const navigateTo = (screen) => {
            currentScreen = screen;
            dom.listScreen.classList.toggle('d-none', screen !== 'list');
            dom.formScreen.classList.toggle('d-none', screen !== 'form');
            dom.productIdScreen.classList.toggle('d-none', screen !== 'details');
        };

        const showToast = (message, type = 'success') => {
            dom.toastEl.classList.remove('text-bg-success', 'text-bg-info', 'text-bg-warning', 'text-bg-danger');
            let bgClass = '';
            switch(type) {
                case 'info': bgClass = 'text-bg-info'; break;
                case 'warning': bgClass = 'text-bg-warning'; break;
                case 'error': bgClass = 'text-bg-danger'; break;
                default: bgClass = 'text-bg-success'; break;
            }
            dom.toastEl.classList.add(bgClass);
            dom.toastBody.textContent = message;
            appToast.show();
        };

        const getStatusClass = (status) => ({
            'Sẵn sàng nhập kho': 'text-bg-success', 'Đã qua KCS': 'text-bg-primary',
            'Mới sản xuất': 'text-bg-warning', 'Đã hủy': 'text-bg-danger'
        }[status] || 'text-bg-secondary');
        
        const closeOpenSwipeContainer = (animate = true) => {
            if (openSwipeContainer) {
                const content = openSwipeContainer.querySelector('.swipe-content');
                content.style.transition = animate ? 'transform 0.2s ease-out' : 'none';
                content.style.transform = 'translateX(0px)';
                openSwipeContainer = null;
            }
        };

        // --- Chức năng Màn hình Danh sách ---
        const renderBatches = (batches) => {
            const activeBatches = batches.filter(b => b.active === 0);
            dom.batchListContainer.innerHTML = '';
            dom.noResults.classList.toggle('d-none', activeBatches.length > 0);
            activeBatches.forEach(batch => {
                const batchCardHTML = `
                <div class="swipe-container position-relative bg-body-tertiary rounded-3 shadow-sm border border-secondary overflow-hidden">
                    <div class="swipe-actions position-absolute top-0 end-0 h-100 d-flex align-items-center">
                        <button data-action="edit" data-code="${batch.batchCode}" class="h-100 btn btn-primary rounded-0 px-4 d-flex flex-column align-items-center justify-content-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="mb-1 pe-none" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V12h2.293z"/></svg>
                            <span class="small fw-semibold pe-none">Sửa</span>
                        </button>
                        <button data-action="delete" data-code="${batch.batchCode}" class="h-100 btn btn-danger rounded-0 px-4 d-flex flex-column align-items-center justify-content-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="mb-1 pe-none" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                            <span class="small fw-semibold pe-none">Xóa</span>
                        </button>
                    </div>
                    <div class="swipe-content bg-body-secondary position-relative z-1 p-3" style="transition: transform 0.2s ease-out; cursor: pointer;" data-code="${batch.batchCode}">
                        <div class="d-flex justify-content-between align-items-start pe-none">
                            <div>
                                <p class="fw-bold text-light mb-1">${batch.batchCode}</p>
                                <p class="small text-body mb-0">${batch.productName}</p>
                            </div>
                            <span class="badge rounded-pill small ${getStatusClass(batch.status)}">${batch.status}</span>
                        </div>
                        <div class="mt-3 d-flex justify-content-between align-items-center small text-secondary pe-none">
                            <span>SL: <span class="fw-semibold text-light">${batch.quantity} ${batch.unit}</span></span>
                            <span>Ngày tạo: <span class="fw-semibold text-light">${batch.creationDate}</span></span>
                        </div>
                    </div>
                </div>`;
                dom.batchListContainer.insertAdjacentHTML('beforeend', batchCardHTML);
            });
            initializeSwipeActions();
        };
        
        function initializeSwipeActions() {
            document.querySelectorAll('.swipe-container').forEach(container => {
                const content = container.querySelector('.swipe-content');
                if (!content) return;
        
                let startX, startY, diffX = 0, diffY = 0, isDragging = false, isScrolling = false;
                const tapThreshold = 10;
        
                const handleTouchStart = (e) => {
                    if (openSwipeContainer && openSwipeContainer !== container) closeOpenSwipeContainer();
                    startX = e.touches[0].clientX; startY = e.touches[0].clientY;
                    diffX = 0; diffY = 0; isDragging = true; isScrolling = false;
                    content.style.transition = 'none';
                };
                
                const handleTouchMove = (e) => {
                    if (!isDragging) return;
                    diffX = e.touches[0].clientX - startX; diffY = e.touches[0].clientY - startY;
                    if (!isScrolling && Math.abs(diffY) > Math.abs(diffX) + 5) isScrolling = true;
                    if(isScrolling) return;
                    e.preventDefault();
                    
                    const actionsWidth = container.querySelector('.swipe-actions').offsetWidth;
                    if (diffX > 0) diffX = 0;
                    if (Math.abs(diffX) > actionsWidth) {
                         const overdrag = Math.abs(diffX) - actionsWidth;
                         diffX = -actionsWidth - (overdrag / 4);
                    }
                    content.style.transform = `translateX(${diffX}px)`;
                };

                const handleTouchEnd = () => {
                    if (!isDragging || isScrolling) { isDragging = false; return; }
                    isDragging = false;
                    content.style.transition = 'transform 0.2s ease-out';
                    
                    const actionsWidth = container.querySelector('.swipe-actions').offsetWidth;
                    if (Math.abs(diffX) < tapThreshold) {
                        if (openSwipeContainer === container) closeOpenSwipeContainer();
                        else setupProductIdScreen(content.dataset.code);
                    } else if (diffX < -actionsWidth / 2) {
                        content.style.transform = `translateX(${-actionsWidth}px)`;
                        openSwipeContainer = container;
                    } else {
                        content.style.transform = 'translateX(0px)';
                        if (openSwipeContainer === container) openSwipeContainer = null;
                    }
                };
        
                content.addEventListener('touchstart', handleTouchStart, { passive: true });
                content.addEventListener('touchmove', handleTouchMove);
                content.addEventListener('touchend', handleTouchEnd);
            });
        }

        const handleSearch = () => {
            const searchTerm = dom.searchInput.value.toLowerCase();
            const filteredBatches = mockBatches.filter(batch => 
                batch.batchCode.toLowerCase().includes(searchTerm) ||
                batch.productName.toLowerCase().includes(searchTerm) ||
                (batch.lsx && batch.lsx.toLowerCase().includes(searchTerm))
            );
            renderBatches(filteredBatches);
        };
        
        // --- Chức năng Màn hình Form (Sửa/Thêm) ---
        const resetFormFields = () => {
            dom.form.reset(); dom.batchCreationDate.valueAsDate = new Date();
            clearAutoFilledFields();
        };
        const clearAutoFilledFields = () => {
            dom.productCode.value = ''; dom.productName.value = ''; dom.bomDisplay.value = '';
            dom.specifications.value = ''; dom.plannedQuantity.value = ''; dom.unit.value = '';
            dom.warranty.value = '';
        };
        const setupFormForAdd = () => {
            currentFormMode = 'add'; editingBatchCode = null;
            dom.formTitle.textContent = 'Khai Báo Lô Sản Phẩm';
            dom.formSubmitButton.textContent = 'Xác Nhận & Lưu Lô';
            dom.batchCode.value = `LSP-${new Date().toISOString().slice(2,10).replace(/-/g,"")}-${String(mockBatches.length + 1).padStart(3, '0')}`;
            resetFormFields(); populateDropdowns();
            dom.declarationTypeRadios[0].checked = true;
            dom.lsxSelectorContainer.classList.remove('d-none');
            dom.bomSelectorContainer.classList.add('d-none');
            navigateTo('form');
        };
        const setupFormForEdit = (batchCode) => {
            const batch = mockBatches.find(b => b.batchCode === batchCode);
            if (!batch) return;
            currentFormMode = 'edit'; editingBatchCode = batchCode;
            dom.formTitle.textContent = 'Chỉnh Sửa Lô Sản Phẩm';
            dom.formSubmitButton.textContent = 'Cập Nhật Lô';
            
            populateDropdowns(); clearAutoFilledFields();
            if (batch.lsx) {
                dom.declarationTypeRadios[0].checked = true;
                dom.lsxSelectorContainer.classList.remove('d-none'); dom.bomSelectorContainer.classList.add('d-none');
                dom.productionOrderSelect.value = batch.lsx;
                fillFormWithData(productionOrders.find(o => o.id === batch.lsx));
            } else if (batch.bomId) {
                dom.declarationTypeRadios[1].checked = true;
                dom.lsxSelectorContainer.classList.add('d-none'); dom.bomSelectorContainer.classList.remove('d-none');
                dom.bomSelect.value = batch.bomId;
                fillFormWithData(boms.find(b => b.id === batch.bomId));
            }
            dom.batchCode.value = batch.batchCode; dom.productName.value = batch.productName;
            dom.batchCreationDate.value = batch.creationDate; dom.actualQuantity.value = batch.quantity; 
            dom.status.value = batch.status; dom.unit.value = batch.unit; dom.batchUnit.value = batch.batchUnit;
            navigateTo('form');
        };
        const handleDelete = (batchCode) => {
            batchCodeToDeleteState = batchCode;
            dom.batchCodeToDelete.textContent = batchCode;
            deleteModal.show();
        };
        const confirmDelete = () => {
            const batchIndex = mockBatches.findIndex(b => b.batchCode === batchCodeToDeleteState);
            if (batchIndex > -1) mockBatches[batchIndex].active = 1;
            deleteModal.hide(); handleSearch();
        };
        const populateDropdowns = () => {
            dom.productionOrderSelect.innerHTML = '<option value="">-- Chọn LSX --</option>';
            dom.bomSelect.innerHTML = '<option value="">-- Chọn BOM --</option>';
            productionOrders.forEach(o => dom.productionOrderSelect.add(new Option(`${o.id} - ${o.productName}`, o.id)));
            boms.forEach(b => dom.bomSelect.add(new Option(`${b.id} - ${b.productName}`, b.id)));
        };
        const fillFormWithData = (data) => {
            if (!data) { clearAutoFilledFields(); return; }
            dom.productCode.value = data.productCode || ''; dom.productName.value = data.productName || '';
            dom.bomDisplay.value = data.bomId || data.id || ''; dom.specifications.value = data.specs || '';
            dom.plannedQuantity.value = data.quantity || ''; dom.actualQuantity.value = data.quantity || '';
            dom.unit.value = data.unit || ''; dom.warranty.value = data.warranty || '';
        };
        const handleFormSubmit = (e) => {
            e.preventDefault();
            const formData = {
                batchCode: dom.batchCode.value, productName: dom.productName.value, bomId: dom.bomDisplay.value,
                lsx: dom.declarationTypeRadios[0].checked ? dom.productionOrderSelect.value : null,
                quantity: parseInt(dom.actualQuantity.value), unit: dom.unit.value, batchUnit: dom.batchUnit.value,
                creationDate: dom.batchCreationDate.value, status: dom.status.value, active: 0,
                // Add default identification fields
                identifiedQuantity: 0, scannedData: {}, palletsPerContainer: null, cartonsPerPallet: null, layersPerCarton: null, itemsPerLayer: null
            };
            if (currentFormMode === 'add') {
                mockBatches.unshift(formData);
            } else {
                const batchIndex = mockBatches.findIndex(b => b.batchCode === editingBatchCode);
                if (batchIndex > -1) mockBatches[batchIndex] = {...mockBatches[batchIndex], ...formData};
            }
            handleSearch(); navigateTo('list');
        };

        // --- Chức năng Màn hình Định danh (ID Screen) ---
        const setupProductIdScreen = (batchCode) => {
            const foundBatch = mockBatches.find(b => b.batchCode === batchCode);
            if (!foundBatch) { showToast('Lỗi: Không tìm thấy lô sản phẩm.', 'error'); return; }

            currentIdBatch = JSON.parse(JSON.stringify(foundBatch)); // Deep copy for editing
            resetIdSession();

            dom.productIdTitle.textContent = `Lô: ${currentIdBatch.batchCode}`;
            dom.infoProductName.textContent = currentIdBatch.productName;
            dom.infoUnit.textContent = currentIdBatch.batchUnit;
            dom.infoTotalQuantity.textContent = currentIdBatch.quantity.toLocaleString('vi-VN');
            dom.infoIdentifiedQuantity.textContent = currentIdBatch.identifiedQuantity.toLocaleString('vi-VN');
            dom.infoRemainingQuantity.textContent = (currentIdBatch.quantity - currentIdBatch.identifiedQuantity).toLocaleString('vi-VN');
            
            showDeclarationLevelsByUnit(currentIdBatch.batchUnit);
            dom.inputs.palletsPerContainer.value = currentIdBatch.palletsPerContainer || '';
            dom.inputs.cartonsPerPallet.value = currentIdBatch.cartonsPerPallet || '';
            dom.inputs.layersPerCarton.value = currentIdBatch.layersPerCarton || '';
            dom.inputs.itemsPerLayer.value = currentIdBatch.itemsPerLayer || '';
            
            currentScanIndices = getIndicesFromTotal(currentIdBatch.identifiedQuantity, currentIdBatch);
            renderScannedData(currentIdBatch.scannedData);
            handleDeclarationChange();
            updateIdButtonStates();
            navigateTo('details');
        };

        const handleDeclarationChange = () => {
            if (!currentIdBatch) return;
            currentIdBatch.itemsPerLayer = parseInt(dom.inputs.itemsPerLayer.value, 10) || null;
            currentIdBatch.layersPerCarton = parseInt(dom.inputs.layersPerCarton.value, 10) || null;
            currentIdBatch.cartonsPerPallet = parseInt(dom.inputs.cartonsPerPallet.value, 10) || null;
            currentIdBatch.palletsPerContainer = parseInt(dom.inputs.palletsPerContainer.value, 10) || null;
            
            const { quantity, batchUnit } = currentIdBatch;
            const { itemsPerLayer = 0, layersPerCarton = 0, cartonsPerPallet = 0, palletsPerContainer = 0 } = currentIdBatch;

            const itemsPerCarton = itemsPerLayer * layersPerCarton;
            const itemsPerPallet = itemsPerCarton * cartonsPerPallet;
            const itemsPerContainer = itemsPerPallet * palletsPerContainer;
            
            const totalContainers = itemsPerContainer > 0 ? Math.ceil(quantity / itemsPerContainer) : 0;
            const totalPallets = itemsPerPallet > 0 ? Math.ceil(quantity / itemsPerPallet) : 0;
            const totalCartons = itemsPerCarton > 0 ? Math.ceil(quantity / itemsPerCarton) : 0;
            
            // Update UI
            let showDivider = false;
            ['carton', 'pallet', 'container', 'total-cartons', 'total-pallets', 'total-containers'].forEach(type => {
                document.getElementById(`calc-${type}-row`).classList.add('d-none');
            });

            if (['Thùng', 'Pallet', 'Container'].includes(batchUnit)) {
                document.getElementById('calc-items-per-carton').textContent = itemsPerCarton > 0 ? itemsPerCarton.toLocaleString('vi-VN') : '-';
                document.getElementById('calc-carton-row').classList.remove('d-none');
                if (totalCartons > 0) { document.getElementById('calc-total-cartons').textContent = totalCartons.toLocaleString('vi-VN'); document.getElementById('calc-total-cartons-row').classList.remove('d-none'); showDivider = true; }
            }
            if (['Pallet', 'Container'].includes(batchUnit)) {
                document.getElementById('calc-items-per-pallet').textContent = itemsPerPallet > 0 ? itemsPerPallet.toLocaleString('vi-VN') : '-';
                document.getElementById('calc-pallet-row').classList.remove('d-none');
                if (totalPallets > 0) { document.getElementById('calc-total-pallets').textContent = totalPallets.toLocaleString('vi-VN'); document.getElementById('calc-total-pallets-row').classList.remove('d-none'); showDivider = true; }
            }
            if (batchUnit === 'Container') {
                document.getElementById('calc-items-per-container').textContent = itemsPerContainer > 0 ? itemsPerContainer.toLocaleString('vi-VN') : '-';
                document.getElementById('calc-container-row').classList.remove('d-none');
                if (totalContainers > 0) { document.getElementById('calc-total-containers').textContent = totalContainers.toLocaleString('vi-VN'); document.getElementById('calc-total-containers-row').classList.remove('d-none'); showDivider = true; }
            }
            document.getElementById('calc-divider').classList.toggle('d-none', !showDivider);
            updateScanProgressUI(); updateIdButtonStates();
        };

        const renderScannedData = (data) => {
            const totalCount = Object.values(data).reduce((pAcc, cartons) => pAcc + Object.values(cartons).reduce((cAcc, layers) => cAcc + Object.values(layers).reduce((lAcc, items) => lAcc + items.length, 0), 0), 0);
            dom.scanCount.textContent = totalCount;
            if (totalCount === 0) {
                dom.idListDetails.innerHTML = '<p class="text-center text-secondary small m-0">Chưa có sản phẩm nào được quét.</p>'; return;
            }
            let html = '';
            const renderLayers = (layers, indentClass = 'ms-4') => Object.entries(layers).map(([layerKey, items]) => `<details open><summary class="${indentClass}">Lớp ${layerKey.split('_')[1]} (${items.length} SP)</summary>${items.map(item => `<p class="item-code font-monospace small">${item}</p>`).join('')}</details>`).join('');
            const renderCartons = (cartons, indentClass = 'ms-2') => Object.entries(cartons).map(([cartonKey, layers]) => `<details open><summary class="fw-bold ${indentClass}">Thùng ${cartonKey.split('_')[1]}</summary>${renderLayers(layers)}</details>`).join('');
            
            if (currentIdBatch.batchUnit === 'Container') {
                 html = Object.entries(data).map(([palletKey, cartons]) => `<details open><summary class="fw-bolder">Pallet ${palletKey.split('_')[1]}</summary>${renderCartons(cartons)}</details>`).join('');
            } else if (data.pallet_1) {
                html = renderCartons(data.pallet_1, 'ms-0 fw-bold');
            }
            dom.idListDetails.innerHTML = html || '<p class="text-center text-secondary small m-0">Chưa có sản phẩm nào được quét.</p>';
        };

        const getDeclaration = (batch) => {
            const b = batch || currentIdBatch;
            if (!b) return { pallets: 1, cartons: 1, layers: 1, items: 1 };
            return {
                pallets: b.palletsPerContainer || 1, cartons: b.cartonsPerPallet || 1,
                layers: b.layersPerCarton || 1, items: b.itemsPerLayer || 1,
            };
        };

        const getIndicesFromTotal = (totalScanned, batch) => {
            if (!batch) return { pallet: 1, carton: 1, layer: 1 };
            const dec = getDeclaration(batch);
            const itemsPerLayer = dec.items || 1, itemsPerCarton = (dec.layers || 1) * itemsPerLayer, itemsPerPallet = (dec.cartons || 1) * itemsPerCarton;
            const scannedIndex = totalScanned;
            let pallet = 1, carton = 1, layer = 1;
            switch (batch.batchUnit) {
                case 'Container':
                    pallet = itemsPerPallet > 0 ? Math.floor(scannedIndex / itemsPerPallet) + 1 : 1;
                    const remP = itemsPerPallet > 0 ? scannedIndex % itemsPerPallet : scannedIndex;
                    carton = itemsPerCarton > 0 ? Math.floor(remP / itemsPerCarton) + 1 : 1;
                    const remC = itemsPerCarton > 0 ? remP % itemsPerCarton : remP;
                    layer = itemsPerLayer > 0 ? Math.floor(remC / itemsPerLayer) + 1 : 1;
                    break;
                case 'Pallet':
                    pallet = 1; 
                    carton = itemsPerCarton > 0 ? Math.floor(scannedIndex / itemsPerCarton) + 1 : 1;
                    const remCP = itemsPerCarton > 0 ? scannedIndex % itemsPerCarton : scannedIndex;
                    layer = itemsPerLayer > 0 ? Math.floor(remCP / itemsPerLayer) + 1 : 1;
                    break;
                case 'Thùng':
                    pallet = 1; carton = 1;
                    layer = itemsPerLayer > 0 ? Math.floor(scannedIndex / itemsPerLayer) + 1 : 1;
                    break;
            }
            return { pallet, carton, layer };
        };

        const updateScanProgressUI = () => {
            if (!currentIdBatch) return;
            const dec = getDeclaration();
            const unit = currentIdBatch.batchUnit;
            dom.progress.pallet.classList.add('d-none'); dom.progress.carton.classList.add('d-none'); dom.progress.layer.classList.add('d-none');
            dom.scanProgressContainer.classList.add('d-none');
            if (unit === 'Container') { dom.progress.pallet.classList.remove('d-none'); dom.progress.pallet.lastElementChild.textContent = `${currentScanIndices.pallet} / ${dec.pallets || 'N/A'}`; }
            if (['Container', 'Pallet'].includes(unit)) { dom.progress.carton.classList.remove('d-none'); dom.progress.carton.lastElementChild.textContent = `${currentScanIndices.carton} / ${dec.cartons || 'N/A'}`; }
            if (['Container', 'Pallet', 'Thùng'].includes(unit)) { dom.progress.layer.classList.remove('d-none'); dom.progress.layer.lastElementChild.textContent = `${currentScanIndices.layer} / ${dec.layers || 'N/A'}`; dom.scanProgressContainer.classList.remove('d-none'); }
        };

        const handleSimulateScan = () => {
            if (!currentIdBatch) return;
            const totalCanScan = currentIdBatch.quantity - currentIdBatch.identifiedQuantity;
            if (sessionScannedCount >= totalCanScan) {
                showToast('Đã quét đủ số lượng còn lại cho lô này.', 'warning');
                idScanModal.hide(); return;
            }
            const dec = getDeclaration();
            const totalBeforeScan = currentIdBatch.identifiedQuantity + sessionScannedCount;
            const { pallet, carton, layer } = getIndicesFromTotal(totalBeforeScan, currentIdBatch);
            
            const palletKey = `pallet_${pallet}`, cartonKey = `carton_${carton}`, layerKey = `layer_${layer}`;
            sessionScannedData[palletKey] = sessionScannedData[palletKey] || {};
            sessionScannedData[palletKey][cartonKey] = sessionScannedData[palletKey][cartonKey] || {};
            sessionScannedData[palletKey][cartonKey][layerKey] = sessionScannedData[palletKey][cartonKey][layerKey] || [];
            
            const scannedId = `${currentIdBatch.productCode}-P${pallet}C${carton}L${layer}-${Date.now().toString().slice(-5)}`;
            sessionScannedData[palletKey][cartonKey][layerKey].push(scannedId);
            sessionScannedCount++;
            dom.modalScanCount.textContent = sessionScannedCount;

            const totalAfterScan = totalBeforeScan + 1;
            const itemsPerLayer = dec.items, itemsPerCarton = dec.layers * itemsPerLayer, itemsPerPallet = dec.cartons * itemsPerCarton;
            if (totalAfterScan > 0 && itemsPerLayer > 0 && totalAfterScan % itemsPerLayer === 0) {
                showToast(`Đã hoàn thành Lớp ${layer}!`, 'info');
                if (itemsPerCarton > 0 && totalAfterScan % itemsPerCarton === 0) {
                    showToast(`Đã hoàn thành Thùng ${carton}!`, 'success');
                    if (currentIdBatch.batchUnit === 'Container' && itemsPerPallet > 0 && totalAfterScan % itemsPerPallet === 0) {
                        showToast(`Đã hoàn thành Pallet ${pallet}!`, 'success');
                    }
                }
            }
            currentScanIndices = getIndicesFromTotal(totalAfterScan, currentIdBatch);
            
            // Merge existing and session data for rendering
            const mergedData = JSON.parse(JSON.stringify(currentIdBatch.scannedData));
            Object.entries(sessionScannedData).forEach(([pKey, pVal]) => {
                mergedData[pKey] = mergedData[pKey] || {};
                Object.entries(pVal).forEach(([cKey, cVal]) => {
                    mergedData[pKey][cKey] = mergedData[pKey][cKey] || {};
                    Object.entries(cVal).forEach(([lKey, lVal]) => {
                        mergedData[pKey][cKey][lKey] = (mergedData[pKey][cKey][lKey] || []).concat(lVal);
                    });
                });
            });

            renderScannedData(mergedData);
            updateScanProgressUI();
            updateIdButtonStates();
        };

        const handleSaveIdentities = () => {
            if (dom.saveIdentitiesButton.disabled || !currentIdBatch) return;
            const batchIndex = mockBatches.findIndex(b => b.batchCode === currentIdBatch.batchCode);
            if (batchIndex > -1) {
                const mainBatch = mockBatches[batchIndex];
                mainBatch.identifiedQuantity += sessionScannedCount;
                // Merge data
                Object.entries(sessionScannedData).forEach(([pKey, pVal]) => {
                    mainBatch.scannedData[pKey] = mainBatch.scannedData[pKey] || {};
                    Object.entries(pVal).forEach(([cKey, cVal]) => {
                        mainBatch.scannedData[pKey][cKey] = mainBatch.scannedData[pKey][cKey] || {};
                        Object.entries(cVal).forEach(([lKey, lVal]) => {
                             mainBatch.scannedData[pKey][cKey][lKey] = (mainBatch.scannedData[pKey][cKey][lKey] || []).concat(lVal);
                        });
                    });
                });
                showToast(`Đã lưu thành công ${sessionScannedCount} mã định danh!`);
                setupProductIdScreen(mainBatch.batchCode); // Refresh the screen
            } else {
                showToast('Lỗi: Không tìm thấy lô hàng để lưu.', 'error');
            }
        };

        const updateIdButtonStates = () => {
            if (!currentIdBatch) { dom.startScanButton.disabled = true; dom.saveIdentitiesButton.disabled = true; return; };
            const remaining = currentIdBatch.quantity - currentIdBatch.identifiedQuantity;
            dom.startScanButton.disabled = remaining <= 0;
            dom.saveIdentitiesButton.disabled = sessionScannedCount === 0;
        };

        const resetIdSession = () => {
            sessionScannedData = {}; sessionScannedCount = 0; dom.modalScanCount.textContent = 0;
        };

        const showDeclarationLevelsByUnit = (unit) => {
            const levels = {
                container: document.getElementById('declaration-container-level'), pallet: document.getElementById('declaration-pallet-level'),
                carton: document.getElementById('declaration-carton-level'), layer: document.getElementById('declaration-layer-level')
            };
            Object.values(levels).forEach(l => l.classList.add('d-none'));
            if (unit === 'Container') Object.values(levels).forEach(l => l.classList.remove('d-none'));
            else if (unit === 'Pallet') { levels.pallet.classList.remove('d-none'); levels.carton.classList.remove('d-none'); levels.layer.classList.remove('d-none'); }
            else if (unit === 'Thùng') { levels.carton.classList.remove('d-none'); levels.layer.classList.remove('d-none'); }
            dom.packagingContainer.classList.toggle('d-none', !unit || unit === 'Cái' || unit === 'Hộp');
        };
        

        // --- GÁN CÁC SỰ KIỆN ---
        const addEventListeners = () => {
            dom.addNewButton.addEventListener('click', setupFormForAdd);
            dom.backToListButton.addEventListener('click', () => navigateTo('list'));
            dom.backToListFromDetailsButton.addEventListener('click', () => navigateTo('list'));
            dom.searchInput.addEventListener('input', handleSearch);
            dom.form.addEventListener('submit', handleFormSubmit);
            dom.confirmDeleteButton.addEventListener('click', confirmDelete);

            dom.batchListContainer.addEventListener('click', (e) => {
                const actionButton = e.target.closest('.swipe-actions button');
                if (actionButton) {
                    const { action, code } = actionButton.dataset;
                    closeOpenSwipeContainer();
                    if (action === 'edit') setupFormForEdit(code);
                    if (action === 'delete') handleDelete(code);
                }
            });
            document.body.addEventListener('click', (e) => {
                if (currentScreen === 'list' && openSwipeContainer && !openSwipeContainer.contains(e.target)) {
                    closeOpenSwipeContainer();
                }
            });
            dom.declarationTypeRadios.forEach(radio => radio.addEventListener('change', (e) => {
                clearAutoFilledFields(); dom.productionOrderSelect.value = ''; dom.bomSelect.value = '';
                dom.lsxSelectorContainer.classList.toggle('d-none', e.target.value !== 'lsx');
                dom.bomSelectorContainer.classList.toggle('d-none', e.target.value !== 'bom');
            }));
            dom.productionOrderSelect.addEventListener('change', (e) => fillFormWithData(productionOrders.find(o => o.id === e.target.value)));
            dom.bomSelect.addEventListener('change', (e) => fillFormWithData(boms.find(b => b.id === e.target.value)));
            
            // Events for product ID screen
            dom.simulateScanButton.addEventListener('click', handleSimulateScan);
            dom.saveIdentitiesButton.addEventListener('click', handleSaveIdentities);
            Object.values(dom.inputs).forEach(input => input.addEventListener('input', handleDeclarationChange));
        };
        
        // --- KHỞI TẠO BAN ĐẦU ---
        const initializeApp = () => {
            deleteModal = new bootstrap.Modal(dom.deleteModalEl);
            idScanModal = new bootstrap.Modal(dom.idScanModalEl);
            appToast = new bootstrap.Toast(dom.toastEl);
            addEventListeners();
            renderBatches(mockBatches);
        };

        initializeApp();
    });
    </script>
</body>
</html>
