<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Quản Lý Lệnh Sản Xuất</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Select2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <!-- Custom CSS -->
    <style>
        /* Custom styles for a better mobile experience - Dark Theme */
        :root {
            --bg-color: #121212;
            --surface-color: #1f2937;
            --primary-border-color: #374151;
            --secondary-border-color: #4b5563;
            --text-primary: #e0e0e0;
            --text-secondary: #9ca3af;
            --text-white: #ffffff;
            --accent-color: #3b82f6;
            --accent-color-light: #60a5fa;
            --delete-color: #ef4444;
            --success-color: #16a34a; /* Green for completed steps */
            --dark-text-color: #212529; /* For text on light backgrounds */
        }

        #PRODUCTION_ORDER {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            min-height: 100vh;
        }

        #PRODUCTION_ORDER .app-header {
            background-color: var(--surface-color);
            color: var(--text-white);
            position: sticky;
            top: 0;
            z-index: 1020;
            padding: 0.75rem 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            border-bottom: 1px solid var(--primary-border-color);
        }

        #PRODUCTION_ORDER .app-header .title { font-size: 1.25rem; font-weight: 600; }
        #PRODUCTION_ORDER .app-header .btn-icon { color: var(--text-white); font-size: 1.5rem; background: none; border: none; }

        #PRODUCTION_ORDER .page { display: none; padding-bottom: 80px; }
        #PRODUCTION_ORDER .page.active { display: block; }
        
        /* Swipeable List Item Styles */
        #PRODUCTION_ORDER .list-item-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #PRODUCTION_ORDER .list-item-actions {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            display: flex;
        }
        #PRODUCTION_ORDER .action-button {
            width: 75px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-white);
            border: none;
            font-size: 0.9rem;
        }
        #PRODUCTION_ORDER .action-button i { font-size: 1.2rem; margin-bottom: 4px; }
        #PRODUCTION_ORDER .action-edit { background-color: var(--accent-color); }
        #PRODUCTION_ORDER .action-delete { background-color: var(--delete-color); }

        #PRODUCTION_ORDER .list-item-content {
            background-color: var(--surface-color);
            border: 1px solid var(--primary-border-color);
            color: var(--text-primary);
            position: relative;
            transition: transform 0.3s ease-out;
            padding: 0.75rem 1.25rem;
        }
        #PRODUCTION_ORDER .list-item-content.swiped {
            transform: translateX(-150px);
        }

        #PRODUCTION_ORDER .list-group-flush .list-group-item {
             background-color: transparent;
             border-color: var(--primary-border-color);
        }

        #PRODUCTION_ORDER .status-badge {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.4em 0.8em;
            border-radius: 50rem;
        }
        #PRODUCTION_ORDER .status-new { background-color: #1e3a8a; color: #bfdbfe; }
        #PRODUCTION_ORDER .status-inprogress { background-color: #9a3412; color: #fed7aa; }
        #PRODUCTION_ORDER .status-completed { background-color: #166534; color: #bbf7d0; }

        #PRODUCTION_ORDER .card {
            background-color: var(--surface-color);
            border: 1px solid var(--primary-border-color);
            border-radius: 0.5rem;
        }
        #PRODUCTION_ORDER .card-title { color: var(--text-white); }

        #PRODUCTION_ORDER .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: var(--text-white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1030;
        }

        /* New Stepper Styles */
        #PRODUCTION_ORDER .stepper-wrapper { display: flex; justify-content: space-between; margin-bottom: 2rem; }
        #PRODUCTION_ORDER .stepper-item { position: relative; display: flex; flex-direction: column; align-items: center; flex: 1; }
        #PRODUCTION_ORDER .stepper-item::before { position: absolute; content: ""; border-bottom: 3px solid var(--secondary-border-color); width: 100%; top: 15px; left: -50%; z-index: 2; }
        #PRODUCTION_ORDER .stepper-item:first-child::before { display: none; }
        #PRODUCTION_ORDER .stepper-item.completed::before { border-color: var(--success-color); }
        #PRODUCTION_ORDER .step-counter { height: 30px; width: 30px; display: flex; justify-content: center; align-items: center; border-radius: 50%; background: var(--secondary-border-color); color: var(--text-secondary); margin-bottom: 6px; z-index: 5; font-weight: bold; }
        #PRODUCTION_ORDER .stepper-item.active .step-counter { background-color: var(--accent-color); color: var(--text-white); }
        #PRODUCTION_ORDER .stepper-item.completed .step-counter { background-color: var(--success-color); color: var(--text-white); font-size: 1rem; }
        #PRODUCTION_ORDER .step-name { font-size: 0.9rem; color: var(--text-secondary); }
        #PRODUCTION_ORDER .stepper-item.active .step-name { color: var(--accent-color); }
        #PRODUCTION_ORDER .stepper-item.completed .step-name { color: var(--text-primary); }

        #PRODUCTION_ORDER .form-control { background-color: var(--primary-border-color); color: var(--text-white); border: 1px solid var(--secondary-border-color); }
        #PRODUCTION_ORDER .form-control:focus { background-color: var(--primary-border-color); color: var(--text-white); border-color: var(--accent-color); box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25); }
        #PRODUCTION_ORDER .form-control::placeholder { color: var(--text-secondary); }
        #PRODUCTION_ORDER input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }

        /* Sliding Pill Tab Styles */
        #PRODUCTION_ORDER .custom-tabs-wrapper { background-color: var(--primary-border-color); border-radius: 50rem; padding: 4px; width: 100%; box-sizing: border-box; }
        #PRODUCTION_ORDER .custom-tabs { display: flex; position: relative; }
        #PRODUCTION_ORDER .tab-item { padding: 0.5rem 1rem; color: var(--text-secondary); font-weight: 600; text-align: center; cursor: pointer; white-space: nowrap; transition: color 0.3s ease; border: none; background: none; flex: 1; z-index: 2; }
        #PRODUCTION_ORDER .tab-item.active { color: var(--text-white); }
        #PRODUCTION_ORDER .tab-indicator { position: absolute; top: 0; left: 0; height: 100%; background-color: var(--surface-color); border-radius: 50rem; box-shadow: 0 1px 3px rgba(0,0,0,0.3); transition: left 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 1; }
        #PRODUCTION_ORDER .po-tab-content .tab-pane { transition: opacity 0.3s ease-in-out; }

        /* New "Add Material" Form Styles */
        #PRODUCTION_ORDER #formAddMaterial, #PRODUCTION_ORDER #formEditMaterial { display: flex; align-items: stretch; gap: 0.5rem; }
        #PRODUCTION_ORDER #formAddMaterial .select2-container, #PRODUCTION_ORDER #formEditMaterial .select2-container { flex-grow: 1; }
        #PRODUCTION_ORDER #formAddMaterial #materialQty, #PRODUCTION_ORDER #formEditMaterial #editMaterialQty { width: 70px; flex-shrink: 0; }
        #PRODUCTION_ORDER #formAddMaterial .btn-info, #PRODUCTION_ORDER #formEditMaterial .btn-info { width: 42px; height: auto; flex-shrink: 0; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 0.25rem; }

        /* New Added Material List Styles */
        #PRODUCTION_ORDER #addedMaterialsList .list-group-item, #PRODUCTION_ORDER #editedMaterialsList .list-group-item { background-color: var(--surface-color); color: var(--text-primary); border-radius: 0.25rem; margin-bottom: 0.5rem; border: 1px solid var(--primary-border-color); padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; font-weight: 500; }
        #PRODUCTION_ORDER #addedMaterialsList .btn-delete-material, #PRODUCTION_ORDER #editedMaterialsList .btn-delete-material { background-color: var(--delete-color); color: var(--text-white); border: none; width: 35px; height: 35px; border-radius: 0.25rem; display: flex; align-items: center; justify-content: center; padding: 0; }

        /* Select2 Dark Theme Overrides (Global) */
        .select2-container--default .select2-selection--single { background-color: var(--primary-border-color); border: 1px solid var(--secondary-border-color); height: calc(1.5em + .75rem + 2px); border-radius: .25rem; }
        .select2-container--default .select2-selection--single .select2-selection__rendered { color: var(--text-white); line-height: calc(1.5em + .75rem); padding-left: .75rem; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: calc(1.5em + .75rem); }
        .select2-container--default .select2-selection--single .select2-selection__arrow b { border-color: var(--text-secondary) transparent transparent transparent; margin-top: 2px; }
        .select2-container--default.select2-container--open .select2-selection--single .select2-selection__arrow b { border-color: transparent transparent var(--text-secondary) transparent; }
        .select2-dropdown { background-color: var(--surface-color); border: 1px solid var(--secondary-border-color); border-radius: .25rem; }
        .select2-container--default .select2-search--dropdown .select2-search__field { background-color: var(--bg-color); color: var(--text-white); border: 1px solid var(--secondary-border-color); border-radius: .25rem; }
        .select2-container--default .select2-results__option--highlighted.select2-results__option--selectable { background-color: var(--accent-color); color: var(--text-white); }
        .select2-results__option { color: var(--text-primary); }
        .select2-container--default .select2-results__option--selected { background-color: #555; }
        .select2-selection__clear { color: var(--text-secondary) !important; font-size: 1.2rem !important; }

    </style>
</head>
<body>

    <div id="PRODUCTION_ORDER">
        <!-- Main View: Production Order List -->
        <div id="listView" class="page active">
            <div class="app-header">
                <div class="d-flex align-items-center justify-content-center position-relative">
                    <span class="title">Lệnh Sản Xuất</span>
                </div>
            </div>
            <div class="container-fluid pt-3">
                <div id="productionOrderList"></div>
            </div>
            <a href="#" id="btnAddOrder" class="fab">
                <i class="fas fa-plus"></i>
            </a>
        </div>

        <!-- Detail View: Order Details -->
        <div id="detailView" class="page">
            <div class="app-header">
                <div class="d-flex align-items-center justify-content-between">
                    <button class="btn-icon btn-back"><i class="fas fa-arrow-left"></i></button>
                    <span class="title" id="detailOrderId"></span>
                    <div style="width: 24px;"></div> <!-- Spacer -->
                </div>
            </div>
            <div class="container-fluid pt-3">
                <div class="custom-tabs-wrapper">
                    <div class="custom-tabs" id="detailTabs">
                        <button class="tab-item active" data-target="#generalInfo">Thông Tin Chung</button>
                        <button class="tab-item" data-target="#materialsList">Vật Tư</button>
                        <div class="tab-indicator"></div>
                    </div>
                </div>
                <div class="tab-content po-tab-content pt-3" id="myTabContent">
                    <div class="tab-pane fade show active" id="generalInfo" role="tabpanel">
                        <div class="card"><div class="card-body" id="detailInfoContent"></div></div>
                    </div>
                    <div class="tab-pane fade" id="materialsList" role="tabpanel">
                         <div class="card">
                            <div class="card-body">
                                 <h5 class="card-title">Danh sách vật tư</h5>
                                <ul class="list-group list-group-flush" id="detailMaterialsContent"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit View: 2-Step Form -->
        <div id="addView" class="page">
            <div class="app-header">
                <div class="d-flex align-items-center justify-content-between">
                    <button class="btn-icon btn-back"><i class="fas fa-arrow-left"></i></button>
                    <span class="title">Thêm Lệnh Sản Xuất</span>
                    <div style="width: 24px;"></div> <!-- Spacer -->
                </div>
            </div>
            <div class="container-fluid pt-3">
                <div class="stepper-wrapper">
                    <div id="stepper-1" class="stepper-item active"><div class="step-counter">1</div><div class="step-name">Thông tin</div></div>
                    <div id="stepper-2" class="stepper-item"><div class="step-counter">2</div><div class="step-name">Vật tư</div></div>
                </div>
                <div id="addStep1">
                    <form id="formStep1">
                        <div class="form-group"><label for="orderId">Mã Lệnh SX</label><input type="text" class="form-control" id="orderId" placeholder="VD: LSX001" required></div>
                        <div class="form-group"><label for="productName">Tên Sản Phẩm</label><select class="form-control" id="productName" style="width: 100%;" required></select></div>
                        <div class="form-group"><label for="quantity">Số Lượng</label><input type="number" class="form-control" id="quantity" placeholder="VD: 100" required></div>
                        <div class="form-group"><label for="startDate">Ngày Bắt Đầu</label><input type="date" class="form-control" id="startDate" required></div>
                        <button type="submit" class="btn btn-primary btn-block">Tiếp Theo <i class="fas fa-arrow-right ml-2"></i></button>
                    </form>
                </div>
                <div id="addStep2" style="display: none;">
                    <div class="card mb-3"><div class="card-body"><h5 class="card-title">Thông tin lệnh</h5><div id="orderSummary"></div></div></div>
                    <div class="card">
                         <div class="card-body">
                             <h5 class="card-title">Thêm vật tư</h5>
                            <form id="formAddMaterial" class="mb-3">
                                <select class="form-control" id="materialName"></select>
                                <input type="number" class="form-control" id="materialQty" placeholder="SL" required>
                                <button type="submit" class="btn btn-info"><i class="fas fa-plus"></i></button>
                            </form>
                            <ul id="addedMaterialsList" class="list-group list-group-flush px-0"></ul>
                         </div>
                    </div>
                    <button id="btnSaveOrder" class="btn btn-success btn-block mt-3">Lưu Lệnh Sản Xuất</button>
                </div>
            </div>
        </div>
        
        <!-- Edit View: Edit Order -->
        <div id="editView" class="page">
            <div class="app-header">
                <div class="d-flex align-items-center justify-content-between">
                    <button class="btn-icon btn-back"><i class="fas fa-arrow-left"></i></button>
                    <span class="title">Sửa Lệnh Sản Xuất</span>
                    <div style="width: 24px;"></div> <!-- Spacer -->
                </div>
            </div>
            <div class="container-fluid pt-3">
                <div class="custom-tabs-wrapper">
                    <div class="custom-tabs" id="editTabs">
                        <button class="tab-item active" data-target="#editGeneralInfo">Thông Tin Chung</button>
                        <button class="tab-item" data-target="#editMaterialsList">Vật Tư</button>
                        <div class="tab-indicator"></div>
                    </div>
                </div>
                <div class="tab-content po-tab-content pt-3" id="editTabContent">
                    <!-- Edit General Info Pane -->
                    <div class="tab-pane fade show active" id="editGeneralInfo" role="tabpanel">
                        <form id="formEditInfo">
                            <div class="form-group"><label>Mã Lệnh SX</label><input type="text" class="form-control" id="editOrderId" readonly></div>
                            <div class="form-group"><label for="editProductName">Tên Sản Phẩm</label><select class="form-control" id="editProductName" style="width: 100%;" required></select></div>
                            <div class="form-group"><label for="editQuantity">Số Lượng</label><input type="number" class="form-control" id="editQuantity" placeholder="VD: 100" required></div>
                            <div class="form-group"><label for="editStartDate">Ngày Bắt Đầu</label><input type="date" class="form-control" id="editStartDate" required></div>
                        </form>
                    </div>
                    <!-- Edit Materials Pane -->
                    <div class="tab-pane fade" id="editMaterialsList" role="tabpanel">
                         <div class="card">
                            <div class="card-body">
                                 <h5 class="card-title">Thêm vật tư</h5>
                                <form id="formEditMaterial" class="mb-3">
                                    <select class="form-control" id="editMaterialName"></select>
                                    <input type="number" class="form-control" id="editMaterialQty" placeholder="SL" required>
                                    <button type="submit" class="btn btn-info"><i class="fas fa-plus"></i></button>
                                </form>
                                <ul id="editedMaterialsList" class="list-group list-group-flush px-0"></ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container-fluid px-0">
                    <button id="btnUpdateOrder" class="btn btn-success btn-block mt-3">Lưu Thay Đổi</button>
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
    function initProductionOrderModule() {
        // --- DATA ---
        let productionOrders = [
            { id: 'LSX-24-001', product: 'Tủ quần áo 3 cánh', quantity: 50, startDate: '2024-07-20', status: 'completed', materials: [{name: 'Gỗ MDF', qty: 100}, {name: 'Sơn PU', qty: 20}, {name: 'Bản lề', qty: 150}] },
            { id: 'LSX-24-002', product: 'Bàn ăn 6 người', quantity: 30, startDate: '2024-07-22', status: 'inprogress', materials: [{name: 'Gỗ Sồi', qty: 60}, {name: 'Dầu lau', qty: 15}] },
            { id: 'LSX-24-003', product: 'Kệ TV treo tường', quantity: 120, startDate: '2024-07-25', status: 'new', materials: [] },
        ];
        let newOrderData = { info: {}, materials: [] }; // Used for both add and edit
        let products = [ { id: 'P01', text: 'Tủ quần áo 3 cánh' }, { id: 'P02', text: 'Bàn ăn 6 người' }, { id: 'P03', text: 'Kệ TV treo tường' }, { id: 'P04', text: 'Giường ngủ gỗ sồi' }, { id: 'P05', text: 'Bộ sofa phòng khách' }, ];
        let materials = [ { id: 'M01', text: 'Gỗ MDF' }, { id: 'M02', text: 'Sơn PU' }, { id: 'M03', text: 'Bản lề' }, { id: 'M04', text: 'Gỗ Sồi' }, { id: 'M05', text: 'Dầu lau' }, { id: 'M06', text: 'Vít các loại' }, ];
        let editingOrderId = null;

        // --- FUNCTIONS ---
        function navigateTo(pageId) { $('#PRODUCTION_ORDER .page').removeClass('active'); $(pageId).addClass('active'); }
        function renderOrderList() {
            const listEl = $('#productionOrderList'); listEl.empty();
            if (productionOrders.length === 0) { listEl.html('<p class="text-center text-muted">Chưa có lệnh sản xuất nào.</p>'); return; }
            productionOrders.forEach(order => {
                const statusInfo = getStatusInfo(order.status);
                const orderHtml = `<div class="list-item-wrapper"><div class="list-item-actions"><button class="action-button action-edit" data-id="${order.id}"><i class="fas fa-pen"></i>Sửa</button><button class="action-button action-delete" data-id="${order.id}"><i class="fas fa-trash"></i>Xoá</button></div><div class="list-item-content" data-id="${order.id}"><div class="d-flex w-100 justify-content-between"><h5 class="mb-1 font-weight-bold" style="color: var(--accent-color-light);">${order.id}</h5><small class="text-muted">${order.startDate}</small></div><p class="mb-1">${order.product} - SL: ${order.quantity}</p><small><span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></small></div></div>`;
                listEl.append(orderHtml);
            });
        }
        function renderOrderDetail(orderId) {
            const order = productionOrders.find(o => o.id === orderId); if (!order) return;
            $('#detailOrderId').text(order.id);
            const infoContent = `<p><strong>Sản phẩm:</strong> ${order.product}</p><p><strong>Số lượng:</strong> ${order.quantity}</p><p><strong>Ngày bắt đầu:</strong> ${order.startDate}</p><p><strong>Trạng thái:</strong> <span class="status-badge ${getStatusInfo(order.status).class}">${getStatusInfo(order.status).text}</span></p>`;
            $('#detailInfoContent').html(infoContent);
            const materialsContent = $('#detailMaterialsContent'); materialsContent.empty();
            if (order.materials.length > 0) { order.materials.forEach(mat => { materialsContent.append(`<li class="list-group-item d-flex justify-content-between align-items-center">${mat.name} <span class="badge badge-primary badge-pill">${mat.qty}</span></li>`); }); } else { materialsContent.html('<li class="list-group-item text-muted">Không có vật tư cho lệnh này.</li>'); }
            setTimeout(() => updateTabIndicator($('#detailTabs')), 50);
        }
        function renderAddedMaterials() {
            const listEl = $('#addedMaterialsList'); listEl.empty();
            if (newOrderData.materials.length === 0) { listEl.html('<p class="text-center text-muted small mt-2">Chưa có vật tư nào được thêm.</p>'); return; }
            newOrderData.materials.forEach((mat, index) => { listEl.append(`<li class="list-group-item"><span>${mat.name} - SL: ${mat.qty}</span><button class="btn-delete-material" data-index="${index}"><i class="fas fa-trash"></i></button></li>`); });
        }
        function renderEditedMaterials() {
            const listEl = $('#editedMaterialsList'); listEl.empty();
            if (newOrderData.materials.length === 0) { listEl.html('<p class="text-center text-muted small mt-2">Chưa có vật tư nào được thêm.</p>'); return; }
            newOrderData.materials.forEach((mat, index) => { listEl.append(`<li class="list-group-item"><span>${mat.name} - SL: ${mat.qty}</span><button class="btn-delete-material" data-index="${index}"><i class="fas fa-trash"></i></button></li>`); });
        }
        function getStatusInfo(status) {
            switch (status) { case 'new': return { text: 'Mới', class: 'status-new' }; case 'inprogress': return { text: 'Đang SX', class: 'status-inprogress' }; case 'completed': return { text: 'Hoàn thành', class: 'status-completed' }; default: return { text: 'Không xác định', class: '' }; }
        }
        function resetStepper() {
            $('#stepper-1').addClass('active').removeClass('completed');
            $('#stepper-2').removeClass('active').removeClass('completed');
            $('#stepper-1 .step-counter').html('1');
            $('#stepper-2 .step-counter').html('2');
        }
        function populateEditForm(order) {
            $('#editOrderId').val(order.id);
            $('#editQuantity').val(order.quantity);
            $('#editStartDate').val(order.startDate);
            const product = products.find(p => p.text === order.product);
            if (product) { $('#editProductName').val(product.id).trigger('change'); }
            newOrderData.materials = JSON.parse(JSON.stringify(order.materials));
            renderEditedMaterials();
            $('#editTabs .tab-item:first').addClass('active').siblings().removeClass('active');
            $('#editTabContent .tab-pane:first').addClass('show active').siblings().removeClass('show active');
            setTimeout(() => updateTabIndicator($('#editTabs')), 50);
        }
        function updateTabIndicator(tabsContainer) {
            const activeTab = tabsContainer.find('.tab-item.active');
            const indicator = tabsContainer.find('.tab-indicator');
            if (activeTab.length) {
                indicator.css({
                    left: activeTab[0].offsetLeft + 'px',
                    width: activeTab[0].offsetWidth + 'px'
                });
            }
        }

        // --- INITIALIZE SELECT2 ---
        $('#productName').select2({ data: products, placeholder: "Chọn hoặc tìm sản phẩm", allowClear: true });
        $('#materialName').select2({ data: materials, placeholder: "Chọn vật tư", allowClear: true });
        $('#editProductName').select2({ data: products, placeholder: "Chọn hoặc tìm sản phẩm", allowClear: true });
        $('#editMaterialName').select2({ data: materials, placeholder: "Chọn vật tư", allowClear: true });
        
        // --- EVENT HANDLERS (GENERAL) ---
        // Detach previous handlers to avoid multiple bindings if init is called again
        $(document).off('click', '#PRODUCTION_ORDER .action-button');
        $('#PRODUCTION_ORDER').off();

        $('#btnAddOrder').on('click', function(e) { e.preventDefault(); $('#formStep1')[0].reset(); $('#productName').val(null).trigger('change'); resetStepper(); $('#addStep1').show(); $('#addStep2').hide(); newOrderData = { info: {}, materials: [] }; navigateTo('#addView'); });
        $('.btn-back').on('click', function() { navigateTo('#listView'); });
        
        // --- ADD ORDER LOGIC ---
        $('#formStep1').on('submit', function(e) {
            e.preventDefault(); const selectedProduct = $('#productName').select2('data')[0]; if (!selectedProduct || selectedProduct.text === "") { alert('Vui lòng chọn một sản phẩm.'); return; }
            newOrderData.info = { id: $('#orderId').val(), product: selectedProduct.text, quantity: $('#quantity').val(), startDate: $('#startDate').val(), status: 'new' };
            const summaryHtml = `<p class="mb-1"><strong>Mã lệnh:</strong> ${newOrderData.info.id}</p><p class="mb-0"><strong>Sản phẩm:</strong> ${newOrderData.info.product} (SL: ${newOrderData.info.quantity})</p>`;
            $('#orderSummary').html(summaryHtml);
            $('#stepper-1 .step-counter').html('<i class="fas fa-check"></i>');
            $('#stepper-1').removeClass('active').addClass('completed');
            $('#stepper-2').addClass('active');
            $('#addStep1').hide();
            $('#addStep2').show();
            renderAddedMaterials();
        });
        $('#formAddMaterial').on('submit', function(e) {
            e.preventDefault(); const selectedMaterial = $('#materialName').select2('data')[0]; const materialQty = $('#materialQty').val();
            if (selectedMaterial && selectedMaterial.text !== "" && materialQty) {
                newOrderData.materials.push({ name: selectedMaterial.text, qty: parseInt(materialQty) });
                renderAddedMaterials(); $('#materialQty').val(''); $('#materialName').val(null).trigger('change'); $('#materialName').select2('open');
            }
        });
        $('#addedMaterialsList').on('click', '.btn-delete-material', function() { newOrderData.materials.splice($(this).data('index'), 1); renderAddedMaterials(); });
        $('#btnSaveOrder').on('click', function() { productionOrders.unshift({ ...newOrderData.info, materials: newOrderData.materials }); renderOrderList(); navigateTo('#listView'); alert('Đã lưu lệnh sản xuất thành công!'); });
        
        // --- EDIT ORDER LOGIC ---
        $('#formEditMaterial').on('submit', function(e) {
            e.preventDefault(); const selectedMaterial = $('#editMaterialName').select2('data')[0]; const materialQty = $('#editMaterialQty').val();
            if (selectedMaterial && selectedMaterial.text !== "" && materialQty) {
                newOrderData.materials.push({ name: selectedMaterial.text, qty: parseInt(materialQty) });
                renderEditedMaterials(); $('#editMaterialQty').val(''); $('#editMaterialName').val(null).trigger('change'); $('#editMaterialName').select2('open');
            }
        });
        $('#editedMaterialsList').on('click', '.btn-delete-material', function() { newOrderData.materials.splice($(this).data('index'), 1); renderEditedMaterials(); });
        $('#btnUpdateOrder').on('click', function() {
            const orderIndex = productionOrders.findIndex(o => o.id === editingOrderId);
            if (orderIndex > -1) {
                const selectedProduct = $('#editProductName').select2('data')[0];
                productionOrders[orderIndex].product = selectedProduct ? selectedProduct.text : '';
                productionOrders[orderIndex].quantity = $('#editQuantity').val();
                productionOrders[orderIndex].startDate = $('#editStartDate').val();
                productionOrders[orderIndex].materials = newOrderData.materials;
                renderOrderList();
                navigateTo('#listView');
                alert('Đã cập nhật lệnh sản xuất!');
            }
            editingOrderId = null;
        });

        // --- TABS & SWIPE & CLICK LOGIC ---
        $('.custom-tabs').on('click', '.tab-item', function(e) {
            e.preventDefault();
            const $this = $(this);
            if ($this.hasClass('active')) return;

            const tabsContainer = $this.closest('.custom-tabs');
            tabsContainer.find('.tab-item').removeClass('active');
            $this.addClass('active');
            
            const targetPaneId = $this.data('target');
            $(targetPaneId).siblings('.tab-pane').removeClass('show active');
            $(targetPaneId).addClass('show active');

            updateTabIndicator(tabsContainer);
        });
        let startX, startY, swipedItem = null, isSwiping = false, didMove = false; const threshold = 50; const maxSwipe = 150;
        function closeSwipedItem() { if (swipedItem) { swipedItem.removeClass('swiped').css('transform', 'translateX(0)'); swipedItem = null; } }
        $('#productionOrderList').on('touchstart', '.list-item-content', function(e) { startX = e.originalEvent.touches[0].clientX; startY = e.originalEvent.touches[0].clientY; isSwiping = false; didMove = false; $(this).css('transition', 'none'); });
        $('#productionOrderList').on('touchmove', '.list-item-content', function(e) {
            if (e.originalEvent.touches.length === 0) return; let currentX = e.originalEvent.touches[0].clientX; let currentY = e.originalEvent.touches[0].clientY; let diffX = startX - currentX; let diffY = Math.abs(startY - currentY); if (!didMove) didMove = true;
            if (!isSwiping && Math.abs(diffX) > diffY && Math.abs(diffX) > 10) { isSwiping = true; if (swipedItem && swipedItem[0] !== $(this)[0]) { closeSwipedItem(); } }
            if (isSwiping) { e.preventDefault(); requestAnimationFrame(() => { let moveX = 0; if (diffX > 0) { moveX = diffX > maxSwipe ? maxSwipe + (diffX - maxSwipe) * 0.4 : diffX; $(this).css('transform', `translateX(${-moveX}px)`); } else { $(this).css('transform', `translateX(${-diffX}px)`); } }); }
        });
        $('#productionOrderList').on('touchend', '.list-item-content', function(e) {
            if (!isSwiping) return; $(this).css('transition', 'transform 0.3s ease-out'); let diffX = startX - e.originalEvent.changedTouches[0].clientX;
            if (diffX > threshold) { $(this).addClass('swiped').css('transform', `translateX(-${maxSwipe}px)`); swipedItem = $(this); } else { $(this).removeClass('swiped').css('transform', 'translateX(0)'); if (swipedItem && swipedItem[0] === $(this)[0]) { swipedItem = null; } }
        });
        $(document).on('click', '#PRODUCTION_ORDER', function(e) {
            const $target = $(e.target); const $clickedContent = $target.closest('.list-item-content'); if (didMove) { return; }
            if ($clickedContent.length) { if ($clickedContent.hasClass('swiped')) { closeSwipedItem(); } else { closeSwipedItem(); const orderId = $clickedContent.data('id'); renderOrderDetail(orderId); $('#detailTabs .tab-item:first').addClass('active').siblings().removeClass('active'); $('#myTabContent .tab-pane:first').addClass('show active').siblings().removeClass('show active'); navigateTo('#detailView'); } } else if (swipedItem && !$target.closest('.action-button')) { closeSwipedItem(); }
        });
        $('#productionOrderList').on('click', '.action-button', function(e) {
            e.stopPropagation(); const orderId = $(this).data('id');
            if($(this).hasClass('action-edit')) { 
                editingOrderId = orderId;
                const orderToEdit = productionOrders.find(o => o.id === editingOrderId);
                if (orderToEdit) {
                    populateEditForm(orderToEdit);
                    navigateTo('#editView');
                }
            }
            if($(this).hasClass('action-delete')) { if (confirm(`Bạn có chắc muốn xoá lệnh sản xuất ${orderId}?`)) { productionOrders = productionOrders.filter(o => o.id !== orderId); renderOrderList(); swipedItem = null; } }
        });

        // --- INITIALIZATION ---
        renderOrderList();
    }
    
    // When running this file standalone, initialize the module on document ready.
    // In a larger app, you can call initProductionOrderModule() whenever you load this view.
    $(document).ready(function() {
        initProductionOrderModule();
    });
    </script>
</body>
</html>

