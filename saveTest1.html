<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Quản Lý Lệnh Sản Xuất</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Select2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <!-- Custom CSS -->
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1f2937;
            --primary-border-color: #374151;
            --secondary-border-color: #4b5563;
            --text-primary: #e0e0e0;
            --text-secondary: #9ca3af;
            --text-white: #ffffff;
            --accent-color: #3b82f6;
            --accent-color-light: #60a5fa;
            --delete-color: #ef4444;
            --success-color: #16a34a;
        }

        #PRODUCTION_ORDER {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            min-height: 100vh;
        }

        #PRODUCTION_ORDER .app-header {
            background-color: var(--surface-color);
            color: var(--text-white);
            position: sticky;
            top: 0;
            z-index: 1020;
            padding: 0.75rem 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            border-bottom: 1px solid var(--primary-border-color);
        }

        #PRODUCTION_ORDER .app-header .title { font-size: 1.25rem; font-weight: 600; }
        #PRODUCTION_ORDER .app-header .btn-icon { color: var(--text-white); font-size: 1.5rem; background: none; border: none; }

        #PRODUCTION_ORDER .page { display: none; padding-bottom: 80px; }
        #PRODUCTION_ORDER .page.active { display: block; }
        
        #PRODUCTION_ORDER .list-item-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #PRODUCTION_ORDER .list-item-actions {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            display: flex;
        }
        #PRODUCTION_ORDER .action-button {
            width: 75px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-white);
            border: none;
            font-size: 0.9rem;
        }
        #PRODUCTION_ORDER .action-button i { font-size: 1.2rem; margin-bottom: 4px; }
        #PRODUCTION_ORDER .action-edit { background-color: var(--accent-color); }
        #PRODUCTION_ORDER .action-delete { background-color: var(--delete-color); }

        #PRODUCTION_ORDER .list-item-content {
            background-color: var(--surface-color);
            border: 1px solid var(--primary-border-color);
            color: var(--text-primary);
            position: relative;
            transition: transform 0.3s ease-out;
            padding: 0.75rem 1.25rem;
            /* Tối ưu hóa hiệu năng animation, báo cho trình duyệt biết thuộc tính này sẽ thay đổi */
            will-change: transform;
        }
        #PRODUCTION_ORDER .list-item-content.swiped {
            transform: translateX(-150px);
        }
        #PRODUCTION_ORDER .status-badge {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.4em 0.8em;
            border-radius: 50rem;
        }
        #PRODUCTION_ORDER .status-new { background-color: #1e3a8a; color: #bfdbfe; }
        #PRODUCTION_ORDER .status-inprogress { background-color: #9a3412; color: #fed7aa; }
        #PRODUCTION_ORDER .status-completed { background-color: #166534; color: #bbf7d0; }

        #PRODUCTION_ORDER .card {
            background-color: var(--surface-color);
            border: 1px solid var(--primary-border-color);
            border-radius: 0.5rem;
        }
        #PRODUCTION_ORDER .card-title { color: var(--text-white); }

        #PRODUCTION_ORDER .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: var(--text-white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1030;
        }

        /* Stepper Styles */
        #PRODUCTION_ORDER .stepper-wrapper { display: flex; justify-content: space-between; margin-bottom: 2rem; }
        #PRODUCTION_ORDER .stepper-item { position: relative; display: flex; flex-direction: column; align-items: center; flex: 1; }
        #PRODUCTION_ORDER .stepper-item::before { position: absolute; content: ""; border-bottom: 3px solid var(--secondary-border-color); width: 100%; top: 15px; left: -50%; z-index: 2; }
        #PRODUCTION_ORDER .stepper-item:first-child::before { display: none; }
        #PRODUCTION_ORDER .stepper-item.completed::before { border-color: var(--success-color); }
        #PRODUCTION_ORDER .step-counter { height: 30px; width: 30px; display: flex; justify-content: center; align-items: center; border-radius: 50%; background: var(--secondary-border-color); color: var(--text-secondary); margin-bottom: 6px; z-index: 5; font-weight: bold; }
        #PRODUCTION_ORDER .stepper-item.active .step-counter { background-color: var(--accent-color); color: var(--text-white); }
        #PRODUCTION_ORDER .stepper-item.completed .step-counter { background-color: var(--success-color); color: var(--text-white); font-size: 1rem; }
        #PRODUCTION_ORDER .step-name { font-size: 0.9rem; color: var(--text-secondary); }
        #PRODUCTION_ORDER .stepper-item.active .step-name { color: var(--accent-color); }
        #PRODUCTION_ORDER .stepper-item.completed .step-name { color: var(--text-primary); }

        #PRODUCTION_ORDER .form-control { background-color: var(--primary-border-color); color: var(--text-white); border: 1px solid var(--secondary-border-color); }
        #PRODUCTION_ORDER .form-control:focus { background-color: var(--primary-border-color); color: var(--text-white); border-color: var(--accent-color); box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25); }
        #PRODUCTION_ORDER .form-control::placeholder { color: var(--text-secondary); }
        #PRODUCTION_ORDER input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }

        /* Sliding Pill Tab Styles */
        #PRODUCTION_ORDER .custom-tabs-wrapper { background-color: var(--primary-border-color); border-radius: 50rem; padding: 4px; width: 100%; box-sizing: border-box; }
        #PRODUCTION_ORDER .custom-tabs { display: flex; position: relative; }
        #PRODUCTION_ORDER .tab-item { padding: 0.5rem 1rem; color: var(--text-secondary); font-weight: 600; text-align: center; cursor: pointer; white-space: nowrap; transition: color 0.3s ease; border: none; background: none; flex: 1; z-index: 2; }
        #PRODUCTION_ORDER .tab-item.active { color: var(--text-white); }
        #PRODUCTION_ORDER .tab-indicator { position: absolute; top: 0; left: 0; height: 100%; background-color: var(--surface-color); border-radius: 50rem; box-shadow: 0 1px 3px rgba(0,0,0,0.3); transition: left 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 1; }
        
        /* Isolated Tab Panes */
        #PRODUCTION_ORDER .po-tab-content > .tab-pane { display: none; }
        #PRODUCTION_ORDER .po-tab-content > .tab-pane.active.show { display: block; }

        /* Material List Styles */
        #PRODUCTION_ORDER #po-formAddMaterial, #PRODUCTION_ORDER #po-formEditMaterial { display: flex; align-items: stretch; gap: 0.5rem; }
        #PRODUCTION_ORDER #po-formAddMaterial .select2-container, #PRODUCTION_ORDER #po-formEditMaterial .select2-container { flex-grow: 1; }
        #PRODUCTION_ORDER #po-formAddMaterial #po-materialQty, #PRODUCTION_ORDER #po-formEditMaterial #po-editMaterialQty { width: 70px; flex-shrink: 0; }
        #PRODUCTION_ORDER #po-formAddMaterial .btn-info, #PRODUCTION_ORDER #po-formEditMaterial .btn-info { width: 42px; height: auto; flex-shrink: 0; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 0.25rem; }
        
        /* === THAY ĐỔI: Chuyển danh sách vật tư sang theme tối === */
        #PRODUCTION_ORDER #po-addedMaterialsList .list-group-item,
        #PRODUCTION_ORDER #po-editedMaterialsList .list-group-item,
        #PRODUCTION_ORDER #po-detailMaterialsContent .list-group-item {
            background-color: var(--primary-border-color);
            color: var(--text-primary);
            border: 1px solid var(--secondary-border-color);
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }

        #PRODUCTION_ORDER #po-addedMaterialsList .btn-delete-material, #PRODUCTION_ORDER #po-editedMaterialsList .btn-delete-material {
            background-color: var(--delete-color);
            color: var(--text-white);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        #PRODUCTION_ORDER #po-detailMaterialsContent .badge-primary {
            background-color: var(--accent-color);
            color: var(--text-white);
        }

        /* Select2 Dark Theme */
        .select2-container--default .select2-selection--single { background-color: var(--primary-border-color); border: 1px solid var(--secondary-border-color); height: calc(1.5em + .75rem + 2px); border-radius: .25rem; }
        .select2-container--default .select2-selection--single .select2-selection__rendered { color: var(--text-white); line-height: calc(1.5em + .75rem); padding-left: .75rem; }
        .select2-container--default .select2-selection--single .select2-selection__arrow b { border-color: var(--text-secondary) transparent transparent transparent; }
        .select2-dropdown { background-color: var(--surface-color); border: 1px solid var(--secondary-border-color); }
        .select2-container--default .select2-search--dropdown .select2-search__field { background-color: var(--bg-color); color: var(--text-white); border: 1px solid var(--secondary-border-color); }
        .select2-container--default .select2-results__option--highlighted.select2-results__option--selectable { background-color: var(--accent-color); }
    </style>
</head>
<body>

    <div id="PRODUCTION_ORDER">
        <div id="po-listView" class="page active">
            <header class="app-header">
                <div class="d-flex align-items-center justify-content-center position-relative">
                    <h1 class="title text-center m-0 flex-grow-1">Lệnh sản xuất</h1>
                </div>
            </header>
            <div class="container-fluid pt-3">
                <div id="po-productionOrderList"></div>
            </div>
            <a href="#" id="po-btnAddOrder" class="fab">
                <i class="fas fa-plus"></i>
            </a>
        </div>

        <!-- Detail View: Order Details -->
        <div id="po-detailView" class="page">
            <div class="app-header">
                <div class="d-flex align-items-center justify-content-between">
                    <button class="btn-icon btn-back"><i class="fas fa-arrow-left"></i></button>
                    <span class="title" id="po-detailOrderId"></span>
                    <div style="width: 24px;"></div>
                </div>
            </div>
            <div class="container-fluid pt-3">
                <div class="custom-tabs-wrapper">
                    <div class="custom-tabs" id="po-detailTabs">
                        <button class="tab-item active" data-target="#po-generalInfo">Thông Tin Chung</button>
                        <button class="tab-item" data-target="#po-materialsList">Vật Tư</button>
                        <div class="tab-indicator"></div>
                    </div>
                </div>
                <div class="po-tab-content pt-3" id="po-myTabContent">
                    <div class="tab-pane fade show active" id="po-generalInfo" role="tabpanel">
                        <div class="card"><div class="card-body" id="po-detailInfoContent"></div></div>
                    </div>
                    <div class="tab-pane fade" id="po-materialsList" role="tabpanel">
                         <div class="card">
                            <div class="card-body">
                                <ul class="list-group list-group-flush" id="po-detailMaterialsContent"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit View: 2-Step Form -->
        <div id="po-addView" class="page">
            <div class="app-header">
                <div class="d-flex align-items-center justify-content-between">
                    <button class="btn-icon btn-back"><i class="fas fa-arrow-left"></i></button>
                    <span class="title">Thêm Lệnh Sản Xuất</span>
                    <div style="width: 24px;"></div>
                </div>
            </div>
            <div class="container-fluid pt-3">
                <div class="stepper-wrapper">
                    <div id="po-stepper-1" class="stepper-item active"><div class="step-counter">1</div><div class="step-name">Thông tin</div></div>
                    <div id="po-stepper-2" class="stepper-item"><div class="step-counter">2</div><div class="step-name">Vật tư</div></div>
                </div>
                <div id="po-addStep1">
                    <form id="po-formStep1">
                        <div class="form-group"><label for="po-orderId">Mã Lệnh SX</label><input type="text" class="form-control" id="po-orderId" placeholder="VD: LSX001" required></div>
                        <div class="form-group"><label for="po-productName">Tên Sản Phẩm</label><select class="form-control" id="po-productName" style="width: 100%;" required></select></div>
                        <div class="form-group"><label for="po-quantity">Số Lượng</label><input type="number" class="form-control" id="po-quantity" placeholder="VD: 100" required></div>
                        <div class="form-group"><label for="po-startDate">Ngày Bắt Đầu</label><input type="date" class="form-control" id="po-startDate" required></div>
                        <button type="submit" class="btn btn-primary btn-block">Tiếp Theo <i class="fas fa-arrow-right ml-2"></i></button>
                    </form>
                </div>
                <div id="po-addStep2" style="display: none;">
                    <div class="card mb-3"><div class="card-body py-2" id="po-orderSummary"></div></div>
                    <div class="card">
                        <div class="card-header py-2"><h5 class="card-title mb-0">Thêm vật tư</h5></div>
                         <div class="card-body">
                            <form id="po-formAddMaterial" class="mb-3">
                                <select class="form-control" id="po-materialName"></select>
                                <input type="number" class="form-control" id="po-materialQty" placeholder="SL" required>
                                <button type="submit" class="btn btn-info"><i class="fas fa-plus"></i></button>
                            </form>
                            <ul id="po-addedMaterialsList" class="list-group list-group-flush px-0"></ul>
                         </div>
                    </div>
                    <button id="po-btnSaveOrder" class="btn btn-success btn-block mt-3">Lưu Lệnh Sản Xuất</button>
                </div>
            </div>
        </div>
        
        <!-- Edit View: Edit Order -->
        <div id="po-editView" class="page">
            <div class="app-header">
                <div class="d-flex align-items-center justify-content-between">
                    <button class="btn-icon btn-back"><i class="fas fa-arrow-left"></i></button>
                    <span class="title">Sửa Lệnh Sản Xuất</span>
                    <div style="width: 24px;"></div>
                </div>
            </div>
            <div class="container-fluid pt-3">
                <div class="custom-tabs-wrapper">
                    <div class="custom-tabs" id="po-editTabs">
                        <button class="tab-item active" data-target="#po-editGeneralInfo">Thông Tin Chung</button>
                        <button class="tab-item" data-target="#po-editMaterialsList">Vật Tư</button>
                        <div class="tab-indicator"></div>
                    </div>
                </div>
                <div class="po-tab-content pt-3" id="po-editTabContent">
                    <div class="tab-pane fade show active" id="po-editGeneralInfo" role="tabpanel">
                        <form id="po-formEditInfo">
                            <div class="form-group"><label>Mã Lệnh SX</label><input type="text" class="form-control" id="po-editOrderId" readonly></div>
                            <div class="form-group"><label for="po-editProductName">Tên Sản Phẩm</label><select class="form-control" id="po-editProductName" style="width: 100%;" required></select></div>
                            <div class="form-group"><label for="po-editQuantity">Số Lượng</label><input type="number" class="form-control" id="po-editQuantity" placeholder="VD: 100" required></div>
                            <div class="form-group"><label for="po-editStartDate">Ngày Bắt Đầu</label><input type="date" class="form-control" id="po-editStartDate" required></div>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="po-editMaterialsList" role="tabpanel">
                         <div class="card">
                            <div class="card-header py-2"><h5 class="card-title mb-0">Danh sách vật tư</h5></div>
                            <div class="card-body">
                                <form id="po-formEditMaterial" class="mb-3">
                                    <select class="form-control" id="po-editMaterialName"></select>
                                    <input type="number" class="form-control" id="po-editMaterialQty" placeholder="SL" required>
                                    <button type="submit" class="btn btn-info"><i class="fas fa-plus"></i></button>
                                </form>
                                <ul id="po-editedMaterialsList" class="list-group list-group-flush px-0"></ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container-fluid px-0">
                    <button id="po-btnUpdateOrder" class="btn btn-success btn-block mt-3">Lưu Thay Đổi</button>
                </div>
            </div>
        </div>
      </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
    
function initProductionOrderModule() {
    const $container = $('#PRODUCTION_ORDER');
    // --- DATA ---
    let productionOrders = [
        { id: 'LSX-24-001', product: 'Tủ quần áo 3 cánh', quantity: 50, startDate: '2024-07-20', status: 'completed', materials: [{name: 'Gỗ MDF', qty: 100}, {name: 'Sơn PU', qty: 20}, {name: 'Bản lề', qty: 150}] },
        { id: 'LSX-24-002', product: 'Bàn ăn 6 người', quantity: 30, startDate: '2024-07-22', status: 'inprogress', materials: [{name: 'Gỗ Sồi', qty: 60}, {name: 'Dầu lau', qty: 15}] },
        { id: 'LSX-24-003', product: 'Kệ TV treo tường', quantity: 120, startDate: '2024-07-25', status: 'new', materials: [] },
    ];
    let newOrderData = { info: {}, materials: [] }; // Used for both add and edit
    let products = [ { id: 'P01', text: 'Tủ quần áo 3 cánh' }, { id: 'P02', text: 'Bàn ăn 6 người' }, { id: 'P03', text: 'Kệ TV treo tường' }, { id: 'P04', text: 'Giường ngủ gỗ sồi' }, { id: 'P05', text: 'Bộ sofa phòng khách' }, ];
    let materials = [ { id: 'M01', text: 'Gỗ MDF' }, { id: 'M02', text: 'Sơn PU' }, { id: 'M03', text: 'Bản lề' }, { id: 'M04', text: 'Gỗ Sồi' }, { id: 'M05', text: 'Dầu lau' }, { id: 'M06', text: 'Vít các loại' }, ];
    let editingOrderId = null;

    // --- FUNCTIONS ---
    function navigateTo(pageId) { $container.find('.page').removeClass('active'); $container.find(pageId).addClass('active'); }
    function renderOrderList() {
        const listEl = $container.find('#po-productionOrderList'); listEl.empty();
        if (productionOrders.length === 0) { listEl.html('<p class="text-center text-muted">Chưa có lệnh sản xuất nào.</p>'); return; }
        // Sắp xếp lại danh sách để đưa item mới lên đầu
        const sortedOrders = [...productionOrders].sort((a, b) => b.startDate.localeCompare(a.startDate) || b.id.localeCompare(a.id));
        sortedOrders.forEach(order => {
            const statusInfo = getStatusInfo(order.status);
            const orderHtml = `<div class="list-item-wrapper"><div class="list-item-actions"><button class="action-button action-edit" data-id="${order.id}"><i class="fas fa-pen"></i>Sửa</button><button class="action-button action-delete" data-id="${order.id}"><i class="fas fa-trash"></i>Xoá</button></div><div class="list-item-content" data-id="${order.id}"><div class="d-flex w-100 justify-content-between"><h5 class="mb-1 font-weight-bold" style="color: var(--accent-color-light);">${order.id}</h5><small class="text-muted">${order.startDate}</small></div><p class="mb-1">${order.product} - SL: ${order.quantity}</p><small><span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></small></div></div>`;
            listEl.append(orderHtml);
        });
    }
    function renderOrderDetail(orderId) {
        const order = productionOrders.find(o => o.id === orderId); if (!order) return;
        $container.find('#po-detailOrderId').text(order.id);
        const infoContent = `<p><strong>Sản phẩm:</strong> ${order.product}</p><p><strong>Số lượng:</strong> ${order.quantity}</p><p><strong>Ngày bắt đầu:</strong> ${order.startDate}</p><p><strong>Trạng thái:</strong> <span class="status-badge ${getStatusInfo(order.status).class}">${getStatusInfo(order.status).text}</span></p>`;
        $container.find('#po-detailInfoContent').html(infoContent);
        const materialsContent = $container.find('#po-detailMaterialsContent'); materialsContent.empty();
        if (order.materials.length > 0) { order.materials.forEach(mat => { materialsContent.append(`<li class="list-group-item">${mat.name} <span class="badge badge-primary badge-pill">${mat.qty}</span></li>`); }); } else { materialsContent.html('<li class="list-group-item text-muted">Không có vật tư cho lệnh này.</li>'); }
        setTimeout(() => updateTabIndicator($container.find('#po-detailTabs')), 50);
    }
    function renderAddedMaterials() {
        const listEl = $container.find('#po-addedMaterialsList'); listEl.empty();
        if (newOrderData.materials.length === 0) { listEl.html('<p class="text-center text-muted small mt-2">Chưa có vật tư nào được thêm.</p>'); return; }
        newOrderData.materials.forEach((mat, index) => { listEl.append(`<li class="list-group-item"><span>${mat.name} - SL: ${mat.qty}</span><button class="btn-delete-material" data-index="${index}"><i class="fas fa-trash"></i></button></li>`); });
    }
    function renderEditedMaterials() {
        const listEl = $container.find('#po-editedMaterialsList'); listEl.empty();
        if (newOrderData.materials.length === 0) { listEl.html('<p class="text-center text-muted small mt-2">Chưa có vật tư nào được thêm.</p>'); return; }
        newOrderData.materials.forEach((mat, index) => { listEl.append(`<li class="list-group-item"><span>${mat.name} - SL: ${mat.qty}</span><button class="btn-delete-material" data-index="${index}"><i class="fas fa-trash"></i></button></li>`); });
    }
    function getStatusInfo(status) {
        switch (status) { case 'new': return { text: 'Mới', class: 'status-new' }; case 'inprogress': return { text: 'Đang SX', class: 'status-inprogress' }; case 'completed': return { text: 'Hoàn thành', class: 'status-completed' }; default: return { text: 'Không xác định', class: '' }; }
    }
    function resetStepper() {
        const stepper1 = $container.find('#po-stepper-1');
        const stepper2 = $container.find('#po-stepper-2');
        stepper1.addClass('active').removeClass('completed');
        stepper2.removeClass('active').removeClass('completed');
        stepper1.find('.step-counter').html('1');
        stepper2.find('.step-counter').html('2');
    }
    function populateEditForm(order) {
        $container.find('#po-editOrderId').val(order.id);
        $container.find('#po-editQuantity').val(order.quantity);
        $container.find('#po-editStartDate').val(order.startDate);
        const product = products.find(p => p.text === order.product);
        if (product) { $container.find('#po-editProductName').val(product.id).trigger('change'); }
        newOrderData.materials = JSON.parse(JSON.stringify(order.materials));
        renderEditedMaterials();
        $container.find('#po-editTabs .tab-item:first').addClass('active').siblings().removeClass('active');
        $container.find('#po-editTabContent .tab-pane:first').addClass('show active').siblings().removeClass('show active');
        setTimeout(() => updateTabIndicator($container.find('#po-editTabs')), 50);
    }
    function updateTabIndicator(tabsContainer) {
        const activeTab = tabsContainer.find('.tab-item.active');
        const indicator = tabsContainer.find('.tab-indicator');
        if (activeTab.length) {
            indicator.css({
                left: activeTab[0].offsetLeft + 'px',
                width: activeTab[0].offsetWidth + 'px'
            });
        }
    }

    // --- INITIALIZE SELECT2 ---
    $container.find('#po-productName, #po-editProductName').select2({ data: products, placeholder: "Chọn hoặc tìm sản phẩm", allowClear: true });
    $container.find('#po-materialName, #po-editMaterialName').select2({ data: materials, placeholder: "Chọn vật tư", allowClear: true });
    
    // --- EVENT HANDLERS (GENERAL) ---
    $container.off(); // Detach all previous handlers within the container

    $container.on('click', '#po-btnAddOrder', function(e) { e.preventDefault(); $container.find('#po-formStep1')[0].reset(); $container.find('#po-productName').val(null).trigger('change'); resetStepper(); $container.find('#po-addStep1').show(); $container.find('#po-addStep2').hide(); newOrderData = { info: {}, materials: [] }; navigateTo('#po-addView'); });
    $container.on('click', '.btn-back', function() { navigateTo('#po-listView'); });
    
    // --- ADD ORDER LOGIC ---
    $container.on('submit', '#po-formStep1', function(e) {
        e.preventDefault(); 
        const selectedProduct = $container.find('#po-productName').select2('data')[0]; 
        if (!selectedProduct || selectedProduct.text === "") { alert('Vui lòng chọn một sản phẩm.'); return; }
        newOrderData.info = { id: $container.find('#po-orderId').val(), product: selectedProduct.text, quantity: $container.find('#po-quantity').val(), startDate: $container.find('#po-startDate').val(), status: 'new' };
        const summaryHtml = `<p class="mb-1"><strong>Mã lệnh:</strong> ${newOrderData.info.id}</p><p class="mb-0"><strong>Sản phẩm:</strong> ${newOrderData.info.product} (SL: ${newOrderData.info.quantity})</p>`;
        $container.find('#po-orderSummary').html(summaryHtml);
        const stepper1 = $container.find('#po-stepper-1');
        const stepper2 = $container.find('#po-stepper-2');
        stepper1.find('.step-counter').html('<i class="fas fa-check"></i>');
        stepper1.removeClass('active').addClass('completed');
        stepper2.addClass('active');
        $container.find('#po-addStep1').hide();
        $container.find('#po-addStep2').show();
        renderAddedMaterials();
    });

    $container.on('submit', '#po-formAddMaterial', function(e) {
        e.preventDefault(); 
        const selectedMaterial = $container.find('#po-materialName').select2('data')[0]; 
        const materialQty = $container.find('#po-materialQty').val();
        if (selectedMaterial && selectedMaterial.text !== "" && materialQty) {
            newOrderData.materials.push({ name: selectedMaterial.text, qty: parseInt(materialQty) });
            renderAddedMaterials(); 
            $container.find('#po-materialQty').val(''); 
            $container.find('#po-materialName').val(null).trigger('change'); 
            $container.find('#po-materialName').select2('open');
        }
    });

    $container.on('click', '#po-addedMaterialsList .btn-delete-material', function() { newOrderData.materials.splice($(this).data('index'), 1); renderAddedMaterials(); });
    $container.on('click', '#po-btnSaveOrder', function() { productionOrders.unshift({ ...newOrderData.info, materials: newOrderData.materials }); renderOrderList(); navigateTo('#po-listView'); alert('Đã lưu lệnh sản xuất thành công!'); });
    
    // --- EDIT ORDER LOGIC ---
    $container.on('submit', '#po-formEditMaterial', function(e) {
        e.preventDefault(); 
        const selectedMaterial = $container.find('#po-editMaterialName').select2('data')[0]; 
        const materialQty = $container.find('#po-editMaterialQty').val();
        if (selectedMaterial && selectedMaterial.text !== "" && materialQty) {
            newOrderData.materials.push({ name: selectedMaterial.text, qty: parseInt(materialQty) });
            renderEditedMaterials(); 
            $container.find('#po-editMaterialQty').val(''); 
            $container.find('#po-editMaterialName').val(null).trigger('change'); 
            $container.find('#po-editMaterialName').select2('open');
        }
    });

    $container.on('click', '#po-editedMaterialsList .btn-delete-material', function() { newOrderData.materials.splice($(this).data('index'), 1); renderEditedMaterials(); });
    $container.on('click', '#po-btnUpdateOrder', function() {
        const orderIndex = productionOrders.findIndex(o => o.id === editingOrderId);
        if (orderIndex > -1) {
            const selectedProduct = $container.find('#po-editProductName').select2('data')[0];
            productionOrders[orderIndex].product = selectedProduct ? selectedProduct.text : '';
            productionOrders[orderIndex].quantity = $container.find('#po-editQuantity').val();
            productionOrders[orderIndex].startDate = $container.find('#po-editStartDate').val();
            productionOrders[orderIndex].materials = newOrderData.materials;
            renderOrderList();
            navigateTo('#po-listView');
            alert('Đã cập nhật lệnh sản xuất!');
        }
        editingOrderId = null;
    });

    // --- TABS & SWIPE & CLICK LOGIC ---
    $container.on('click', '.custom-tabs .tab-item', function(e) {
        e.preventDefault();
        const $this = $(this);
        if ($this.hasClass('active')) return;

        const tabsContainer = $this.closest('.custom-tabs');
        const tabContentContainer = $this.closest('.page').find('.po-tab-content');

        tabsContainer.find('.tab-item').removeClass('active');
        $this.addClass('active');
        
        const targetPaneId = $this.data('target');
        tabContentContainer.find('.tab-pane').removeClass('show active');
        tabContentContainer.find(targetPaneId).addClass('show active');

        updateTabIndicator(tabsContainer);
    });

    let startX, swipedItem = null, isSwiping = false, didMove = false; 
    const threshold = 50; 
    const maxSwipe = 150;
    
    function closeSwipedItem() { 
        if (swipedItem) { 
            // Thêm transition để item trượt về mượt mà và reset transform
            swipedItem.css('transition', 'transform 0.3s ease-out');
            swipedItem.removeClass('swiped').css('transform', 'translateX(0)');
            swipedItem = null; 
        } 
    }

    $container.on('touchstart', '#po-productionOrderList .list-item-content', function(e) { 
        // === THAY ĐỔI: Nếu có item khác đang mở -> đóng nó lại ===
        if (swipedItem && swipedItem[0] !== $(this)[0]) {
            closeSwipedItem();
        }
        startX = e.originalEvent.touches[0].clientX; 
        isSwiping = false; 
        didMove = false; 
        // Bỏ transition khi bắt đầu chạm để di chuyển theo ngón tay
        $(this).css('transition', 'none'); 
    });

    $container.on('touchmove', '#po-productionOrderList .list-item-content', function(e) {
        // === TỐI ƯU: Cache lại đối tượng jQuery $(this) để không phải gọi lại nhiều lần ===
        const $this = $(this);
        if (e.originalEvent.touches.length === 0) return; 
        let currentX = e.originalEvent.touches[0].clientX; 
        let diffX = startX - currentX; 
        if (!didMove) didMove = true;
        if (Math.abs(diffX) > 10) isSwiping = true; 
        
        if (isSwiping) { 
            e.preventDefault(); 
            requestAnimationFrame(() => { 
                let moveX = diffX > 0 ? Math.min(diffX, maxSwipe + 50) : Math.max(diffX, -50); 
                $this.css('transform', `translateX(${-moveX}px)`); 
            }); 
        }
    });

    $container.on('touchend', '#po-productionOrderList .list-item-content', function(e) {
        if (!didMove) return; // Nếu không di chuyển, không xử lý gì cả
        
        const $this = $(this);
        // Thêm lại transition để có hiệu ứng mượt mà khi kết thúc chạm
        $this.css('transition', 'transform 0.3s ease-out'); 
        
        if(isSwiping) {
            let diffX = startX - e.originalEvent.changedTouches[0].clientX;
            if (diffX > threshold) { 
                $this.addClass('swiped'); 
                $this.css('transform', `translateX(-${maxSwipe}px)`);
                swipedItem = $this; 
            } else { 
                $this.removeClass('swiped').css('transform', 'translateX(0)'); 
                if (swipedItem && swipedItem[0] === $this[0]) { 
                    swipedItem = null; 
                } 
            }
        } else {
             // Nếu không phải là swipe (chỉ là tap), đóng item đang mở (nếu có)
             if (swipedItem) closeSwipedItem();
        }
    });
    
    // Đóng item đang trượt khi click ra ngoài
    $(document).on('click', function(e) {
        const $target = $(e.target);
        if (swipedItem && !$target.closest('#PRODUCTION_ORDER .list-item-wrapper').length) {
            closeSwipedItem();
        }
    });
    
    // Xử lý sự kiện click trên item
    $container.on('click', '.list-item-content', function(e) {
        // Chỉ xử lý click nếu người dùng không có ý định vuốt
        if (didMove) return;

        if ($(this).hasClass('swiped')) {
            closeSwipedItem();
        } else {
            // Đóng item khác đang mở trước khi mở chi tiết
            if (swipedItem) {
                closeSwipedItem();
                return;
            }
            const orderId = $(this).data('id');
            renderOrderDetail(orderId);
            navigateTo('#po-detailView');
        }
    });

    $container.on('click', '.action-button', function(e) {
        e.stopPropagation(); 
        const orderId = $(this).data('id');
        const orderToEdit = productionOrders.find(o => o.id === orderId);

        if($(this).hasClass('action-edit')) { 
            if (orderToEdit) {
                editingOrderId = orderId;
                populateEditForm(orderToEdit);
                navigateTo('#po-editView');
            }
        }
        if($(this).hasClass('action-delete')) { 
            if (confirm(`Bạn có chắc muốn xoá lệnh sản xuất ${orderId}?`)) { 
                productionOrders = productionOrders.filter(o => o.id !== orderId); 
                renderOrderList(); 
                swipedItem = null; 
            } 
        }
    });

    // --- INITIALIZATION ---
    renderOrderList();
}
    
    $(document).ready(function() {
        initProductionOrderModule();
    });
    </script>
</body>
</html>

