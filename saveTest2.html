<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Quản lý BOM Sản phẩm</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Select2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <!-- Custom CSS -->
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1f2937;
            --primary-border-color: #374151;
            --secondary-border-color: #4b5563;
            --text-primary: #e0e0e0;
            --text-secondary: #9ca3af;
            --text-white: #ffffff;
            --accent-color: #3b82f6;
            --accent-color-light: #60a5fa;
            --delete-color: #ef4444;
            --success-color: #16a34a;
        }

        #BOM_DECLARATION {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            min-height: 100vh;
        }

        #BOM_DECLARATION .app-header {
            background-color: var(--surface-color);
            color: var(--text-white);
            position: sticky;
            top: 0;
            z-index: 1020;
            padding: 0.75rem 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            border-bottom: 1px solid var(--primary-border-color);
        }

        #BOM_DECLARATION .app-header .title { font-size: 1.25rem; font-weight: 600; }
        #BOM_DECLARATION .app-header .btn-icon { color: var(--text-white); font-size: 1.5rem; background: none; border: none; }

        #BOM_DECLARATION .page { display: none; padding-bottom: 80px; }
        #BOM_DECLARATION .page.active { display: block; }
        
        #BOM_DECLARATION .list-item-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #BOM_DECLARATION .list-item-actions {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            display: flex;
        }
        #BOM_DECLARATION .action-button {
            width: 75px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-white);
            border: none;
            font-size: 0.9rem;
        }
        #BOM_DECLARATION .action-button i { font-size: 1.2rem; margin-bottom: 4px; }
        #BOM_DECLARATION .action-edit { background-color: var(--accent-color); }
        #BOM_DECLARATION .action-delete { background-color: var(--delete-color); }

        #BOM_DECLARATION .list-item-content {
            background-color: var(--surface-color);
            border: 1px solid var(--primary-border-color);
            color: var(--text-primary);
            position: relative;
            transition: transform 0.3s ease-out;
            padding: 0.75rem 1.25rem;
        }
        #BOM_DECLARATION .list-item-content.swiped {
            transform: translateX(-150px);
        }
        #BOM_DECLARATION .bom-version-badge {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.2em 0.6em;
            border-radius: 50rem;
            background-color: var(--secondary-border-color);
            color: var(--text-primary);
        }

        #BOM_DECLARATION .card {
            background-color: var(--surface-color);
            border: 1px solid var(--primary-border-color);
            border-radius: 0.5rem;
        }
        #BOM_DECLARATION .card-title { color: var(--text-white); }
        #BOM_DECLARATION .detail-value { color: var(--text-white); }

        #BOM_DECLARATION .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: var(--text-white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1030;
        }

        /* Stepper Styles */
        #BOM_DECLARATION .stepper-wrapper { display: flex; justify-content: space-between; margin-bottom: 2rem; }
        #BOM_DECLARATION .stepper-item { position: relative; display: flex; flex-direction: column; align-items: center; flex: 1; }
        #BOM_DECLARATION .stepper-item::before { position: absolute; content: ""; border-bottom: 3px solid var(--secondary-border-color); width: 100%; top: 15px; left: -50%; z-index: 2; }
        #BOM_DECLARATION .stepper-item:first-child::before { display: none; }
        #BOM_DECLARATION .stepper-item.completed::before { border-color: var(--success-color); }
        #BOM_DECLARATION .step-counter { height: 30px; width: 30px; display: flex; justify-content: center; align-items: center; border-radius: 50%; background: var(--secondary-border-color); color: var(--text-secondary); margin-bottom: 6px; z-index: 5; font-weight: bold; }
        #BOM_DECLARATION .stepper-item.active .step-counter { background-color: var(--accent-color); color: var(--text-white); }
        #BOM_DECLARATION .stepper-item.completed .step-counter { background-color: var(--success-color); color: var(--text-white); font-size: 1rem; }
        #BOM_DECLARATION .step-name { font-size: 0.9rem; color: var(--text-secondary); }
        #BOM_DECLARATION .stepper-item.active .step-name { color: var(--accent-color); }
        #BOM_DECLARATION .stepper-item.completed .step-name { color: var(--text-primary); }

        #BOM_DECLARATION .form-control, #BOM_DECLARATION textarea.form-control { background-color: var(--primary-border-color); color: var(--text-white); border: 1px solid var(--secondary-border-color); }
        #BOM_DECLARATION .form-control:focus { background-color: var(--primary-border-color); color: var(--text-white); border-color: var(--accent-color); box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25); }
        #BOM_DECLARATION .form-control::placeholder { color: var(--text-secondary); }
       
        /* Sliding Pill Tab Styles */
        #BOM_DECLARATION .custom-tabs-wrapper { background-color: var(--primary-border-color); border-radius: 50rem; padding: 4px; width: 100%; box-sizing: border-box; }
        #BOM_DECLARATION .custom-tabs { display: flex; position: relative; }
        #BOM_DECLARATION .tab-item { padding: 0.5rem 1rem; color: var(--text-secondary); font-weight: 600; text-align: center; cursor: pointer; white-space: nowrap; transition: color 0.3s ease; border: none; background: none; flex: 1; z-index: 2; }
        #BOM_DECLARATION .tab-item.active { color: var(--text-white); }
        #BOM_DECLARATION .tab-indicator { position: absolute; top: 0; left: 0; height: 100%; background-color: var(--surface-color); border-radius: 50rem; box-shadow: 0 1px 3px rgba(0,0,0,0.3); transition: left 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 1; }
        
        /* Isolated Tab Panes */
        #BOM_DECLARATION .po-tab-content > .tab-pane { display: none; }
        #BOM_DECLARATION .po-tab-content > .tab-pane.active.show { display: block; }
        
        /* Material List Styles */
        #BOM_DECLARATION #formAddMaterial, #BOM_DECLARATION #formEditMaterial { display: flex; align-items: stretch; gap: 0.5rem; }
        #BOM_DECLARATION #formAddMaterial .select2-container, #BOM_DECLARATION #formEditMaterial .select2-container { flex-grow: 1; }
        #BOM_DECLARATION #formAddMaterial #materialQty, #BOM_DECLARATION #formEditMaterial #editMaterialQty { width: 70px; flex-shrink: 0; }
        #BOM_DECLARATION #formAddMaterial .btn-info, #BOM_DECLARATION #formEditMaterial .btn-info { width: 42px; height: auto; flex-shrink: 0; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 0.25rem; }
        #BOM_DECLARATION #addedMaterialsList .list-group-item, #BOM_DECLARATION #editedMaterialsList .list-group-item { background-color: var(--surface-color); color: var(--text-primary); border-radius: 0.25rem; margin-bottom: 0.5rem; border: 1px solid var(--primary-border-color); padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; font-weight: 500; }
        #BOM_DECLARATION #addedMaterialsList .btn-delete-material, #BOM_DECLARATION #editedMaterialsList .btn-delete-material { background-color: var(--delete-color); color: var(--text-white); border: none; width: 35px; height: 35px; border-radius: 0.25rem; display: flex; align-items: center; justify-content: center; padding: 0; }

        /* Detail Material Table */
        #BOM_DECLARATION .detail-materials-table.table-dark th { background-color: var(--surface-color); }
        #BOM_DECLARATION .detail-materials-table th { border-top: none; font-weight: 600; color: var(--text-secondary); }
        #BOM_DECLARATION .detail-materials-table td { vertical-align: middle; }
        #BOM_DECLARATION .card-body .table { margin-bottom: 0; }

        /* Select2 Dark Theme */
        .select2-container--default .select2-selection--single { background-color: var(--primary-border-color); border: 1px solid var(--secondary-border-color); height: calc(1.5em + .75rem + 2px); border-radius: .25rem; }
        .select2-container--default .select2-selection--single .select2-selection__rendered { color: var(--text-white); line-height: calc(1.5em + .75rem); padding-left: .75rem; }
        .select2-container--default .select2-selection--single .select2-selection__arrow b { border-color: var(--text-secondary) transparent transparent transparent; }
        .select2-dropdown { background-color: var(--surface-color); border: 1px solid var(--secondary-border-color); }
        .select2-container--default .select2-search--dropdown .select2-search__field { background-color: var(--bg-color); color: var(--text-white); border: 1px solid var(--secondary-border-color); }
        .select2-container--default .select2-results__option--highlighted.select2-results__option--selectable { background-color: var(--accent-color); }

    </style>
</head>
<body>

    <div id="BOM_DECLARATION">
        <!-- Main View: BOM List -->
        <div id="bomListView" class="page active">
            <div class="app-header">
                 <div class="d-flex align-items-center justify-content-center position-relative">
                    <span class="title">Quản lý BOM</span>
                </div>
            </div>
            <div class="container-fluid pt-3">
                <div id="bomListContainer"></div>
            </div>
            <a href="#" id="btnAddBom" class="fab">
                <i class="fas fa-plus"></i>
            </a>
        </div>
        
        <!-- Detail View: BOM Details -->
        <div id="detailView" class="page">
            <div class="app-header">
                <div class="d-flex align-items-center justify-content-between">
                    <button class="btn-icon btn-back"><i class="fas fa-arrow-left"></i></button>
                    <span class="title" id="detailBomTitle">Chi tiết BOM</span>
                    <div style="width: 24px;"></div>
                </div>
            </div>
            <div class="container-fluid pt-3">
                <div class="custom-tabs-wrapper">
                    <div class="custom-tabs" id="detailTabs">
                        <button class="tab-item active" data-target="#detailGeneralInfo">Thông Tin Chung</button>
                        <button class="tab-item" data-target="#detailMaterials">Cấu hình vật tư</button>
                        <div class="tab-indicator"></div>
                    </div>
                </div>
                <div class="po-tab-content pt-3" id="detailTabContent">
                    <div class="tab-pane fade show active" id="detailGeneralInfo">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title" id="detailBomName"></h5>
                                <p class="text-secondary" id="detailBomShortDesc"></p>
                                <hr style="border-color: var(--primary-border-color);">
                                <div class="row">
                                    <div class="col-6 mb-2"><strong class="text-secondary d-block">Phiên bản:</strong> <span class="detail-value" id="detailBomVersion"></span></div>
                                    <div class="col-6 mb-2"><strong class="text-secondary d-block">Người thiết kế:</strong> <span class="detail-value" id="detailBomDesigner"></span></div>
                                    <div class="col-6 mb-2"><strong class="text-secondary d-block">Người đặt mẫu:</strong> <span class="detail-value" id="detailBomSampleRequester"></span></div>
                                    <div class="col-6 mb-2"><strong class="text-secondary d-block">Người HT Phần cứng:</strong> <span class="detail-value" id="detailBomHardwareFinisher"></span></div>
                                    <div class="col-12 mb-2"><strong class="text-secondary d-block">Người nạp phần mềm:</strong> <span class="detail-value" id="detailBomSoftwareUploader"></span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="detailMaterials">
                         <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Danh sách vật tư</h5>
                                <table class="table table-dark table-striped detail-materials-table">
                                    <thead>
                                        <tr>
                                            <th>Tên vật tư</th>
                                            <th class="text-right">Số lượng</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detailMaterialsTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add View: 2-Step Form -->
        <div id="addView" class="page">
            <div class="app-header">
                <div class="d-flex align-items-center justify-content-between">
                    <button class="btn-icon btn-back"><i class="fas fa-arrow-left"></i></button>
                    <span class="title">Thêm BOM mới</span>
                    <div style="width: 24px;"></div>
                </div>
            </div>
            <div class="container-fluid pt-3">
                <div class="stepper-wrapper">
                    <div id="stepper-1" class="stepper-item active"><div class="step-counter">1</div><div class="step-name">Thông tin chung</div></div>
                    <div id="stepper-2" class="stepper-item"><div class="step-counter">2</div><div class="step-name">Cấu hình vật tư</div></div>
                </div>
                <div id="addStep1">
                    <form id="formStep1">
                        <div class="form-group"><label>Tên BOM</label><input type="text" class="form-control" id="bomName" placeholder="VD: BOM - iPhone 16 Pro" required></div>
                        <div class="form-group"><label>Tên sản phẩm</label><input type="text" class="form-control" id="bomProductName" placeholder="VD: iPhone 16 Pro" required></div>
                        <div class="form-group"><label>Mô tả ngắn</label><input type="text" class="form-control" id="bomShortDesc" placeholder="VD: BOM cho iPhone 16 Pro 256GB" required></div>
                        <div class="row">
                            <div class="col-6 form-group"><label>Phiên bản</label><input type="text" class="form-control" id="bomVersion" placeholder="VD: v1.0.0" required></div>
                            <div class="col-6 form-group"><label>Người thiết kế</label><input type="text" class="form-control" id="bomDesigner" placeholder="VD: Admin" required></div>
                        </div>
                        <div class="row">
                            <div class="col-6 form-group"><label>Người đặt mẫu</label><input type="text" class="form-control" id="bomSampleRequester" placeholder="Tên người đặt"></div>
                            <div class="col-6 form-group"><label>Người HT Phần cứng</label><input type="text" class="form-control" id="bomHardwareFinisher" placeholder="Tên người hoàn thiện"></div>
                        </div>
                         <div class="form-group"><label>Người nạp phần mềm</label><input type="text" class="form-control" id="bomSoftwareUploader" placeholder="Tên người nạp PM"></div>
                        <button type="submit" class="btn btn-primary btn-block">Tiếp Theo <i class="fas fa-arrow-right ml-2"></i></button>
                    </form>
                </div>
                <div id="addStep2" style="display: none;">
                    <div class="card mb-3"><div class="card-body"><h5 class="card-title">Thông tin BOM</h5><div id="bomSummary"></div></div></div>
                    <div class="card">
                         <div class="card-body">
                             <h5 class="card-title">Thêm vật tư</h5>
                            <form id="formAddMaterial" class="mb-3">
                                <select class="form-control" id="materialName"></select>
                                <input type="number" class="form-control" id="materialQty" placeholder="SL" required>
                                <button type="submit" class="btn btn-info"><i class="fas fa-plus"></i></button>
                            </form>
                            <ul id="addedMaterialsList" class="list-group list-group-flush px-0"></ul>
                         </div>
                    </div>
                    <button id="btnSaveBom" class="btn btn-success btn-block mt-3">Lưu BOM</button>
                </div>
            </div>
        </div>
        
        <!-- Edit View: Edit BOM -->
        <div id="editView" class="page">
            <div class="app-header">
                <div class="d-flex align-items-center justify-content-between">
                    <button class="btn-icon btn-back"><i class="fas fa-arrow-left"></i></button>
                    <span class="title">Sửa BOM</span>
                    <div style="width: 24px;"></div>
                </div>
            </div>
            <div class="container-fluid pt-3">
                <div class="custom-tabs-wrapper">
                    <div class="custom-tabs" id="editTabs">
                        <button class="tab-item active" data-target="#editGeneralInfo">Thông Tin Chung</button>
                        <button class="tab-item" data-target="#editMaterialsList">Cấu hình vật tư</button>
                        <div class="tab-indicator"></div>
                    </div>
                </div>
                <div class="po-tab-content pt-3" id="editTabContent">
                    <div class="tab-pane fade show active" id="editGeneralInfo">
                        <form id="formEditInfo">
                             <div class="form-group"><label>Tên BOM</label><input type="text" class="form-control" id="editBomName" required></div>
                            <div class="form-group"><label>Tên sản phẩm</label><input type="text" class="form-control" id="editBomProductName" required></div>
                            <div class="form-group"><label>Mô tả ngắn</label><input type="text" class="form-control" id="editBomShortDesc" required></div>
                             <div class="row">
                                <div class="col-6 form-group"><label>Phiên bản</label><input type="text" class="form-control" id="editBomVersion" required></div>
                                <div class="col-6 form-group"><label>Người thiết kế</label><input type="text" class="form-control" id="editBomDesigner" required></div>
                            </div>
                             <div class="row">
                                <div class="col-6 form-group"><label>Người đặt mẫu</label><input type="text" class="form-control" id="editBomSampleRequester"></div>
                                <div class="col-6 form-group"><label>Người HT Phần cứng</label><input type="text" class="form-control" id="editBomHardwareFinisher"></div>
                            </div>
                            <div class="form-group"><label>Người nạp phần mềm</label><input type="text" class="form-control" id="editBomSoftwareUploader"></div>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="editMaterialsList">
                         <div class="card">
                            <div class="card-body">
                                 <h5 class="card-title">Thêm vật tư</h5>
                                <form id="formEditMaterial" class="mb-3">
                                    <select class="form-control" id="editMaterialName"></select>
                                    <input type="number" class="form-control" id="editMaterialQty" placeholder="SL" required>
                                    <button type="submit" class="btn btn-info"><i class="fas fa-plus"></i></button>
                                </form>
                                <ul id="editedMaterialsList" class="list-group list-group-flush px-0"></ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container-fluid px-0">
                    <button id="btnUpdateBom" class="btn btn-success btn-block mt-3">Lưu Thay Đổi</button>
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
    function initBomDeclarationModule() {
        const $container = $('#BOM_DECLARATION');

        // --- DATA ---
        let productBOMs = [
            { id: 'BOM001', name: 'BOM - iPhone 16 Pro', productName: 'iPhone 16 Pro', version: 'v1.0.2', shortDesc: 'BOM cho iPhone 16 Pro 256GB.', designer: 'Admin', sampleRequester: 'Steve', hardwareFinisher: 'Jony', softwareUploader: 'Craig', materials: [{name: 'Vi mạch XYZ', qty: 1}, {name: 'Màn hình OLED 6.1"', qty: 1}] },
            { id: 'BOM002', name: 'BOM - Galaxy S25 Ultra', productName: 'Galaxy S25 Ultra', version: 'v2.1.0', shortDesc: 'BOM cho Galaxy S25 Ultra 512GB.', designer: 'Admin', sampleRequester: 'Phil', hardwareFinisher: 'Andy', softwareUploader: 'Hiroshi', materials: [{name: 'Vi mạch ABC', qty: 1}] },
            { id: 'BOM003', name: 'BOM - Macbook Air M4', productName: 'Macbook Air M4', version: 'v1.0.0', shortDesc: 'BOM cho Macbook Air M4 13-inch.', designer: 'Team Apple', sampleRequester: 'Tim', hardwareFinisher: 'John', softwareUploader: 'Kevin', materials: [{name: 'Chip M4', qty: 1}] },
        ];
        let materialsMasterList = [ { id: 'M01', text: 'Vi mạch XYZ' }, { id: 'M02', text: 'Màn hình OLED 6.1"' }, { id: 'M03', text: 'Vỏ Titan' }, { id: 'M04', text: 'Vi mạch ABC' }, { id: 'M05', text: 'Màn hình Dynamic AMOLED' }, { id: 'M06', text: 'Chip M4' }, {id: 'M07', text: 'Vỏ nhôm'} ];
        let tempBomData = {};
        let editingBomId = null;

        // --- RENDER FUNCTIONS ---
        function navigateTo(pageId) { $container.find('.page').removeClass('active'); $container.find(pageId).addClass('active'); }
        function renderBOMList() {
            const listEl = $container.find('#bomListContainer'); listEl.empty();
            if (productBOMs.length === 0) { listEl.html('<p class="text-center text-muted p-3">Chưa có BOM nào.</p>'); return; }
            productBOMs.forEach(bom => {
                const bomHtml = `<div class="list-item-wrapper"><div class="list-item-actions"><button class="action-button action-edit" data-id="${bom.id}"><i class="fas fa-pen"></i>Sửa</button><button class="action-button action-delete" data-id="${bom.id}"><i class="fas fa-trash"></i>Xoá</button></div><div class="list-item-content" data-id="${bom.id}"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1 font-weight-bold" style="color: var(--accent-color-light);">${bom.name}</h6><span class="bom-version-badge">${bom.version}</span></div><p class="mb-1 small text-secondary">${bom.shortDesc}</p></div></div>`;
                listEl.append(bomHtml);
            });
        }
        function renderMaterialList(listId, materials) {
            const listEl = $container.find(listId); listEl.empty();
            if (materials.length === 0) { listEl.html('<p class="text-center text-muted small mt-2">Chưa có vật tư nào.</p>'); return; }
            materials.forEach((mat, index) => { listEl.append(`<li class="list-group-item"><span>${mat.name} - SL: ${mat.qty}</span><button class="btn-delete-material" data-index="${index}"><i class="fas fa-trash"></i></button></li>`); });
        }
         function renderBOMDetail(bomId) {
            const bom = productBOMs.find(b => b.id === bomId); if (!bom) return;
            $container.find('#detailBomTitle').text(bom.name);
            $container.find('#detailBomName').text(bom.name);
            $container.find('#detailBomShortDesc').text(bom.shortDesc);
            $container.find('#detailBomVersion').text(bom.version);
            $container.find('#detailBomDesigner').text(bom.designer);
            $container.find('#detailBomSampleRequester').text(bom.sampleRequester || 'N/A');
            $container.find('#detailBomHardwareFinisher').text(bom.hardwareFinisher || 'N/A');
            $container.find('#detailBomSoftwareUploader').text(bom.softwareUploader || 'N/A');
            
            const materialsTableBody = $container.find('#detailMaterialsTableBody');
            materialsTableBody.empty();
            if (bom.materials.length > 0) { 
                bom.materials.forEach(mat => { 
                    materialsTableBody.append(`<tr><td>${mat.name}</td><td class="text-right">${mat.qty}</td></tr>`); 
                }); 
            } else { 
                materialsTableBody.append('<tr><td colspan="2" class="text-center text-secondary">Không có vật tư.</td></tr>'); 
            }
            setTimeout(() => updateTabIndicator($('#detailTabs')), 50);
        }
        function resetStepper() {
            const stepper1 = $container.find('#stepper-1'), stepper2 = $container.find('#stepper-2');
            stepper1.addClass('active').removeClass('completed');
            stepper2.removeClass('active completed');
            stepper1.find('.step-counter').html('1');
            stepper2.find('.step-counter').html('2');
        }
        function populateEditForm(bom) {
            $container.find('#editBomName').val(bom.name);
            $container.find('#editBomProductName').val(bom.productName);
            $container.find('#editBomShortDesc').val(bom.shortDesc);
            $container.find('#editBomVersion').val(bom.version);
            $container.find('#editBomDesigner').val(bom.designer);
            $container.find('#editBomSampleRequester').val(bom.sampleRequester);
            $container.find('#editBomHardwareFinisher').val(bom.hardwareFinisher);
            $container.find('#editBomSoftwareUploader').val(bom.softwareUploader);
            tempBomData.materials = JSON.parse(JSON.stringify(bom.materials)); // Deep copy
            renderMaterialList('#editedMaterialsList', tempBomData.materials);
            $container.find('#editTabs .tab-item:first').addClass('active').siblings().removeClass('active');
            $container.find('#editTabContent .tab-pane:first').addClass('show active').siblings().removeClass('show active');
            setTimeout(() => updateTabIndicator($container.find('#editTabs')), 50);
        }
        function updateTabIndicator(tabsContainer) {
            const activeTab = tabsContainer.find('.tab-item.active');
            const indicator = tabsContainer.find('.tab-indicator');
            if (activeTab.length) {
                indicator.css({ left: activeTab[0].offsetLeft + 'px', width: activeTab[0].offsetWidth + 'px' });
            }
        }
        
        // --- INITIALIZE SELECT2 ---
        $container.find('#materialName, #editMaterialName').select2({ data: materialsMasterList, placeholder: "Chọn vật tư", allowClear: true });
        
        // --- EVENT HANDLERS ---
        $container.off(); // Detach all previous handlers

        $container.on('click', '#btnAddBom', function(e) { e.preventDefault(); $container.find('#formStep1')[0].reset(); resetStepper(); $container.find('#addStep1').show(); $container.find('#addStep2').hide(); tempBomData = { info: {}, materials: [] }; navigateTo('#addView'); });
        $container.on('click', '.btn-back', function() { navigateTo('#bomListView'); });
        
        // Add BOM Logic
        $container.on('submit', '#formStep1', function(e) {
            e.preventDefault();
            tempBomData.info = { 
                id: `BOM${Date.now()}`, 
                name: $container.find('#bomName').val(), 
                productName: $container.find('#bomProductName').val(), 
                shortDesc: $container.find('#bomShortDesc').val(), 
                version: $container.find('#bomVersion').val(), 
                designer: $container.find('#bomDesigner').val(),
                sampleRequester: $container.find('#bomSampleRequester').val(),
                hardwareFinisher: $container.find('#bomHardwareFinisher').val(),
                softwareUploader: $container.find('#bomSoftwareUploader').val()
            };
            $container.find('#bomSummary').html(`<p class="mb-1"><strong>Tên BOM:</strong> ${tempBomData.info.name}</p><p class="mb-0"><strong>Sản phẩm:</strong> ${tempBomData.info.productName}</p>`);
            const stepper1 = $container.find('#stepper-1'), stepper2 = $container.find('#stepper-2');
            stepper1.find('.step-counter').html('<i class="fas fa-check"></i>');
            stepper1.removeClass('active').addClass('completed');
            stepper2.addClass('active');
            $container.find('#addStep1').hide(); $container.find('#addStep2').show();
            renderMaterialList('#addedMaterialsList', tempBomData.materials);
        });

        $container.on('submit', '#formAddMaterial', function(e) {
            e.preventDefault();
            const selectedMaterial = $container.find('#materialName').select2('data')[0];
            const materialQty = $container.find('#materialQty').val();
            if (selectedMaterial && selectedMaterial.text && materialQty) {
                tempBomData.materials.push({ name: selectedMaterial.text, qty: parseInt(materialQty)});
                renderMaterialList('#addedMaterialsList', tempBomData.materials);
                this.reset();
                $container.find('#materialName').val(null).trigger('change');
            }
        });

        $container.on('click', '#addedMaterialsList .btn-delete-material', function() { tempBomData.materials.splice($(this).data('index'), 1); renderMaterialList('#addedMaterialsList', tempBomData.materials); });
        
        $container.on('click', '#btnSaveBom', function() {
            const newBom = { ...tempBomData.info, materials: tempBomData.materials };
            productBOMs.unshift(newBom);
            renderBOMList();
            navigateTo('#bomListView');
            alert('Đã lưu BOM thành công!');
        });
        
        // Edit BOM Logic
        $container.on('submit', '#formEditMaterial', function(e) {
            e.preventDefault();
            const selectedMaterial = $container.find('#editMaterialName').select2('data')[0];
            const materialQty = $container.find('#editMaterialQty').val();
            if (selectedMaterial && selectedMaterial.text && materialQty) {
                tempBomData.materials.push({ name: selectedMaterial.text, qty: parseInt(materialQty)});
                renderMaterialList('#editedMaterialsList', tempBomData.materials);
                this.reset();
                $container.find('#editMaterialName').val(null).trigger('change');
            }
        });
        $container.on('click', '#editedMaterialsList .btn-delete-material', function() { tempBomData.materials.splice($(this).data('index'), 1); renderMaterialList('#editedMaterialsList', tempBomData.materials); });

        $container.on('click', '#btnUpdateBom', function() {
            const bomIndex = productBOMs.findIndex(b => b.id === editingBomId);
            if (bomIndex > -1) {
                productBOMs[bomIndex] = {
                    ...productBOMs[bomIndex],
                    name: $container.find('#editBomName').val(),
                    productName: $container.find('#editBomProductName').val(),
                    shortDesc: $container.find('#editBomShortDesc').val(),
                    version: $container.find('#editBomVersion').val(),
                    designer: $container.find('#editBomDesigner').val(),
                    sampleRequester: $container.find('#editBomSampleRequester').val(),
                    hardwareFinisher: $container.find('#editBomHardwareFinisher').val(),
                    softwareUploader: $container.find('#editBomSoftwareUploader').val(),
                    materials: tempBomData.materials
                };
                renderBOMList();
                navigateTo('#bomListView');
                alert('Đã cập nhật BOM!');
            }
            editingBomId = null;
        });

        // TABS, SWIPE, CLICK Logic
        $container.on('click', '.custom-tabs .tab-item', function(e) {
            e.preventDefault();
            const $this = $(this);
            if ($this.hasClass('active')) return;
            const tabsContainer = $this.closest('.custom-tabs');
            tabsContainer.find('.tab-item').removeClass('active');
            $this.addClass('active');
            const targetPaneId = $this.data('target');
            $(targetPaneId).siblings('.tab-pane').removeClass('show active');
            $(targetPaneId).addClass('show active');
            updateTabIndicator(tabsContainer);
        });

        let startX, swipedItem = null, isSwiping = false, didMove = false;
        const threshold = 50, maxSwipe = 150;
        function closeSwipedItem() { if (swipedItem) { swipedItem.removeClass('swiped').css('transform', 'translateX(0)'); swipedItem = null; } }

        $container.on('touchstart', '#bomListContainer .list-item-content', function(e) {
            if (swipedItem && swipedItem[0] !== $(this)[0]) {
                closeSwipedItem();
            }
            startX = e.originalEvent.touches[0].clientX; 
            isSwiping = false; 
            didMove = false; 
            $(this).css('transition', 'none'); 
        });
        $container.on('touchmove', '#bomListContainer .list-item-content', function(e) { 
            if (e.originalEvent.touches.length === 0) return; 
            let currentX = e.originalEvent.touches[0].clientX; 
            let diffX = startX - currentX; 
            if (!didMove) didMove = true; 
            if (Math.abs(diffX) > 10) isSwiping = true; 
            if (isSwiping) { 
                e.preventDefault(); 
                let moveX = diffX > 0 ? Math.min(diffX, maxSwipe + 50) : Math.max(diffX, -50); 
                $(this).css('transform', `translateX(${-moveX}px)`); 
            } 
        });
        $container.on('touchend', '#bomListContainer .list-item-content', function(e) { 
            if (!isSwiping) return; 
            $(this).css('transition', 'transform 0.3s ease-out'); 
            let diffX = startX - e.originalEvent.changedTouches[0].clientX; 
            if (diffX > threshold) { 
                $(this).addClass('swiped').css('transform', `translateX(-${maxSwipe}px)`); 
                swipedItem = $(this); 
            } else { 
                $(this).removeClass('swiped').css('transform', 'translateX(0)'); 
                if (swipedItem && swipedItem[0] === $(this)[0]) swipedItem = null; 
            } 
        });
        
        $(document).on('click', function(e) {
            const $target = $(e.target);
            if (swipedItem && !$target.closest('.list-item-wrapper').length) {
                closeSwipedItem();
            }
        });

        $container.on('click', '.list-item-content', function(e){
            if (didMove) return;
            if ($(this).hasClass('swiped')) {
                closeSwipedItem();
            } else {
                const bomId = $(this).data('id');
                renderBOMDetail(bomId);
                navigateTo('#detailView');
            }
        });

        $container.on('click', '.action-button', function(e) {
            e.stopPropagation();
            const bomId = $(this).data('id');
            const bomToEdit = productBOMs.find(b => b.id === bomId);

            if($(this).hasClass('action-edit')) { 
                if (bomToEdit) {
                    editingBomId = bomId;
                    populateEditForm(bomToEdit);
                    navigateTo('#editView');
                }
            }
            if($(this).hasClass('action-delete')) {
                if (confirm(`Bạn có chắc muốn xoá ${bomToEdit.name}?`)) {
                    productBOMs = productBOMs.filter(b => b.id !== bomId);
                    renderBOMList();
                    swipedItem = null;
                }
            }
        });

        // --- INITIALIZATION ---
        renderBOMList();
    }
    
    $(document).ready(function() {
        initBomDeclarationModule();
    });
    </script>
</body>
</html>

