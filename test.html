<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Timeline Fixed Footer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
  <style>
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      margin: 0;
    }
    @media print {
      body * {
        visibility: hidden; /* Ẩn toàn bộ nội dung */
      }
      #bodyBill, #bodyBill * {
        visibility: visible; /* Chỉ hiện #bodyBill */
      }
      #bodyBill {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
    .app-card {
      border-radius: 10px;
      padding: 15px;
      background: #f3f3f3;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 10px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .app-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .app-icon {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
    }
    .app-title {
      font-weight: bold;
      margin: 0;
    }
    .app-subtitle {
      margin: 0;
      color: #6c757d;
      font-size: 14px;
    }
    .app-version {
      font-size: 12px;
      color: #999;
    }
    .timeline-wrapper {
      position: relative;
      padding: 15px 0;
      background: #fff;
    }
    /* Đường line nền */
    .timeline-line {
      position: absolute;
      top: 32px;
      left: 18px;
      right: 18px;
      height: 3px;
      background: #ccc;
      z-index: 1;
    }
    /* Các bước */
    .timeline {
      display: flex;
      justify-content: space-between;
      position: relative;
      z-index: 2;
    }
    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      text-align: center;
    }
    .circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #ccc;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: #fff;
      z-index: 2;
      transition: background 0.3s ease, transform 0.3s ease;
    }
    .step.active .circle {
      background: #0d6efd;
      transform: scale(1.1);
    }
    .step.done .circle {
      background: #198754;
      transform: scale(1.1);
    }
    .label {
      margin-top: 6px;
      font-size: 14px;
      white-space: nowrap;
      transition: opacity 0.3s ease;
    }
    .label.inactive {
      opacity: 0.5;
    }
    /* Line đã hoàn thành */
    .timeline-line-fill {
      position: absolute;
      top: 32px;
      left: 18px;
      height: 3px;
      background: #198754;
      z-index: 1;
      transition: width 0.4s ease;
    }
    /* Nội dung cuộn */
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: #f8f9fa;
    }
    .step-content {
      animation: fadeIn 0.4s ease;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(10px);}
      to {opacity: 1; transform: translateY(0);}
    }
    /* Footer cố định */
    .footer-nav {
      background: #fff;
      border-top: 1px solid #ddd;
      padding: 10px;
    }

    .bill-container {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: white;
    display: none;
    flex-direction: column;
    z-index: 999;
  }
  .bill-header {
    background: #f0f0f0;
    padding: 10px;
    display: flex;
    align-items: center;
    font-weight: bold;
  }
  .bill-header i {
    cursor: pointer;
    margin-right: 10px;
  }
  .bill-content {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    font-family: Arial, sans-serif;
  }
  .bill-footer {
    padding: 10px;
    border-top: 1px solid #ccc;
    text-align: center;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  table, th, td {
    border: 1px solid #ccc;
  }
  th, td {
    padding: 5px;
    text-align: left;
  }

  .scroll-tabs {
      overflow-x: auto;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
      border-bottom: 1px solid #dee2e6;
    }
    .scroll-tabs .nav-item {
      flex: 0 0 auto;
    }
    .scroll-tabs .nav-link {
      white-space: nowrap;
      color: #333;
      padding: 10px 16px;
    }
    .scroll-tabs .nav-link.active {
      font-weight: bold;
      color: #0d6efd !important;
      border-bottom: 3px solid #0d6efd; /* underline ngay tab */
    }
    .scroll-tabs::-webkit-scrollbar { display: none; }

    .swiper {
      width: 100%;
      height: 100%; /* cho demo */
    }
    .swiper-slide {
      height: 100%;
      overflow-y: auto; /* Cho phép cuộn nội dung trong slide */
      -webkit-overflow-scrolling: touch;
      background: #f8f9fa;
      padding: 15px;
    }
    .star-rating {
    font-size: 1.5rem;
    cursor: pointer;
  }
  .star {
    color: #ccc;
    transition: color 0.2s;
  }
  .star.active {
    color: gold;
  }
  .tag-btn.active {
  background: #ff2e55;
  color: white;
  border-color: #ff2e55;
}
  </style>
</head>
<body>
  <div id="all" class="container py-3">
    <h5 class="mb-3">Chức năng:</h5>
  
    <div class="app-card" onclick="openApp('check')">
      <div class="d-flex align-items-center">
        <div class="app-icon" style="background-color:#0dcaf0;">
          <i class="bi bi-archive"></i>
        </div>
        <div class="ms-3 flex-grow-1">
          <p class="app-title">Theo dõi đơn giặt</p>
          <p class="app-subtitle">Theo dõi đơn giặt</p>
        </div>
        <span class="app-version"></span>
      </div>
    </div>
  
    <div class="app-card" onclick="openApp('giat')">
      <div class="d-flex align-items-center">
        <div class="app-icon" style="background-color:#dc3545;">
          <i class="bi bi-card-checklist"></i>
        </div>
        <div class="ms-3 flex-grow-1">
          <p class="app-title">Tạo đơn giặt</p>
          <p class="app-subtitle">Tạo đơn giặt</p>
        </div>
        <span class="app-version"></span>
      </div>
    </div>
  
    <div class="app-card" onclick="openApp('ship')">
      <div class="d-flex align-items-center">
        <div class="app-icon" style="background-color:#fd7e14;">
            <i class="bi bi-truck"></i>
        </div>
        <div class="ms-3 flex-grow-1">
          <p class="app-title">Giao hàng</p>
          <p class="app-subtitle">Theo dõi giao hàng</p>
        </div>
        <span class="app-version"></span>
      </div>
    </div>
  </div>
  <div id="create" class="d-none d-flex flex-column" style="height: 100vh;">
    <!-- Timeline -->
    <div class="d-flex align-items-center p-2 border-bottom bg-white">
      <button class="btnBackHome btn btn-link p-0 me-2">
        <i class="bi bi-arrow-left" style="font-size: 1.5rem;"></i>
      </button>
      <h5 class="mb-0">Tạo đơn giặt</h5>
    </div>

    <div class="flex-grow-1 overflow-auto">
      <div class="timeline-wrapper">
        <div class="timeline-line"></div>
        <div class="timeline-line-fill" id="lineFill" style="width:0"></div>
        <div class="timeline" id="timeline">
          <div class="step active">
            <div class="circle">1</div>
            <div class="label">Tạo đơn</div>
          </div>
          <div class="step">
            <div class="circle">2</div>
            <div class="label">Cân và phân loại</div>
          </div>
          <div class="step">
            <div class="circle">3</div>
            <div class="label">Đơn giá</div>
          </div>
          <div class="step">
            <div class="circle">4</div>
            <div class="label">Thanh toán</div>
          </div>
        </div>
      </div>

      <!-- Nội dung -->
      <div class="content">
        <div class="step-content" data-step="0">
          <div class="container-fluid">
            <h3 class="mb-3">Nhập thông tin đơn hàng</h3>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Tên khách hàng:</label>
                <input type="text" class="form-control" placeholder="Nhập tên khách hàng">
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Địa chỉ:</label>
                <input type="text" class="form-control" placeholder="Nhập địa chỉ">
              </div>
              <div class="col-md-6 col-6">
                <label class="form-label">Số điện thoại:</label>
                <input type="text" class="form-control" placeholder="Nhập số điện thoại">
              </div>
              <div class="col-md-6 col-6">
                <label class="form-label">Loại giặt:</label>
                <select class="form-select">
                  <option>Giặt ướt</option>
                  <option>Giặt khô</option>
                </select>
              </div>
            </div>
        
            <h4 class="mt-4">Chọn máy giặt</h4>
            <div class="row g-3">
              <div class="col-md-6 col-6">
                <label class="form-label">Máy giặt</label>
                <select class="form-select">
                  <option>Máy giặt số 1</option>
                  <option>Máy giặt số 2</option>
                </select>
              </div>
              <div class="col-md-6 col-6">
                <label class="form-label">Máy sấy</label>
                <select class="form-select">
                  <option>Máy sấy số 1</option>
                  <option>Máy sấy số 2</option>
                </select>
              </div>
              <div class="col-md-6 col-6">
                <label class="form-label">Thời gian dự kiến:</label>
                <input type="text" class="form-control" placeholder="Giặt trong 50 phút">
              </div>
              <div class="col-md-6 col-6">
                <label class="form-label">Lượt giặt:</label>
                <input type="text" class="form-control" placeholder="Lượt 1">
              </div>
            </div>
          </div>
        </div>
        
        <div class="step-content d-none" data-step="1">
          <h4>Cân và phân loại đồ giặt</h4>
          <!-- Form nhập -->
          <div class="row g-3 align-items-end">
            <div class="col-md-4 col-12">
              <label class="form-label">Loại đồ:</label>
              <select class="form-select" id="itemType">
                <option value="Quần áo (Cái)">Quần áo (Cái)</option>
                <option value="Chăn (Cái)">Chăn (Cái)</option>
                <option value="Khăn (Cái)">Khăn (Cái)</option>
                <option value="Giày (Đôi)">Giày (Đôi)</option>
              </select>
            </div>
            <div class="col-md-3 col-6">
              <label class="form-label">Số lượng:</label>
              <input type="number" class="form-control" id="itemQty" min="1" value="1">
            </div>
            <div class="col-md-3 col-6">
              <label class="form-label">Số kg:</label>
              <input type="number" class="form-control" id="itemWeight" min="0.1" step="0.1" value="0.5">
            </div>
            <div class="col-md-2 col-12">
              <button class="btn btn-danger w-100" id="addItem">Xác nhận Cân</button>
            </div>
          </div>

          <!-- Bảng hiển thị -->
          <div class="mt-4">
            <table class="table table-bordered table-sm" id="itemTable">
              <thead class="table-light">
                <tr>
                  <th>Loại đồ</th>
                  <th>Số lượng</th>
                  <th>Số kg</th>
                  <th>Xoá</th>
                </tr>
              </thead>
              <tbody>
                <!-- Hàng sẽ được thêm bằng JS -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="step-content d-none" data-step="2">
          <h4>Bảng đơn giá</h4>
          <table id="priceTable" class="table table-bordered">
              <thead>
                  <tr style="font-size: 12px;">
                      <th>Sản phẩm</th>
                      <th>Khối lượng</th>
                      <th>Đơn giá</th>
                      <th>Thành tiền</th>
                  </tr>
              </thead>
              <tbody style="font-size: 12px;"></tbody>
              <tfoot>
                  <tr>
                      <th colspan="3" style="text-align:right;">Tổng cộng</th>
                      <th id="totalAmount">0 đ</th>
                  </tr>
              </tfoot>
          </table>
        </div>
        <div class="step-content d-none" data-step="3">
          <h4>Thanh toán</h4>
          <p class="mb-3"></p>
          
          <!-- Tổng tiền -->
          <h5 class="text-center mb-4">
            Tổng tiền: <span id="total-price" class="text-danger fw-bold">0 VND</span>
          </h5>

          <!-- QR Code -->
          <div class="d-flex justify-content-center mb-4">
            <div id="qrcode"></div>
          </div>
          <div class="text-center" style="margin-bottom: 20px;">
            <button id="create-bill" class="btn btn-success btn-lg">Tạo bill thanh toán</button>
          </div>
          <div class="text-center">
            <button id="success" class="btn btn-success btn-lg">Hoàn tất thanh toán</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer nút -->
    <div class="footer-nav d-flex justify-content-between gap-2 p-2 border-top bg-white">
      <button class="btn btn-secondary" id="btnBack" disabled>Quay lại</button>
      <div id="footer-total">
        <button class="btn btn-primary" id="btnNext">Tiếp tục</button>
      </div>
    </div>
  </div>
  <div id="bill-view" class="d-none" >
    <div class="d-flex align-items-center p-2 border-bottom bg-white">
      <button class="btnBackCreate btn btn-link p-0 me-2">
        <i class="bi bi-arrow-left" style="font-size: 1.5rem;"></i>
      </button>
      <h5 class="mb-0">Bill đơn giặt</h5>
    </div>
    <!-- Header -->
    <div id="bodyBill" style="max-width: 360px; margin:auto; border:1px solid #ccc; padding:10px; font-family:Arial; margin-top: 20px; margin-bottom: 20px;">

      <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #ccc; padding:5px 0;">
        <strong>Phiếu giao nhận</strong>
      </div>
  
    <!-- Thông tin cửa hàng -->
    <div style="text-align:center; margin-top:10px;">
      <h3>Cửa hàng giặt - sấy</h3>
      <p>Hà Đông - Hà Nội</p>
      <p>0123.123.123</p>
    </div>
  
    <!-- Thông tin khách -->
    <table style="width:100%; border-collapse:collapse; margin-top:10px;">
      <tr>
        <td><b>Tên khách hàng:</b></td>
        <td id="bill-customerName"></td>
      </tr>
      <tr>
        <td><b>Số điện thoại:</b></td>
        <td id="bill-phone"></td>
      </tr>
      <tr>
        <td><b>Ngày:</b></td>
        <td id="bill-date"></td>
      </tr>
      <tr>
        <td><b>Giờ:</b></td>
        <td id="bill-time"></td>
      </tr>
      <tr>
        <td><b>Trọng lượng:</b></td>
        <td id="bill-weight"></td>
      </tr>
    </table>
  
    <!-- Bảng item -->
    <table border="1" style="width:100%; border-collapse:collapse; margin-top:10px; text-align:center;">
      <thead>
        <tr style="font-size: 12px;">
          <th>Dịch vụ</th>
          <th>Số lượng</th>
          <th>Khối lượng</th>
          <th>Thành tiền</th>
        </tr>
      </thead>
      <tbody id="bill-items" style="font-size: 12px;"></tbody>
    </table>
  
    <!-- Tổng tiền -->
     <div class="d-flex justify-content-between">
      <div style="width: 40%; padding: 10px; text-align: center;">
        <div id="qrcodeZalo" style="display: flex; justify-content: center;"></div>
        <div style="font-size: 12px;">
            <i>(Truy cập app giặt là thông qua QR)</i>
        </div>
    </div>
        
        <h3 style="width: 60%; text-align:right; margin-top:10px;">Tổng: <span id="bill-total"></span> đ</h3>
     </div>
    
  </div>
    
  
    <!-- Footer -->
    <div class="footer-nav d-flex justify-content-between gap-2 p-2 border-top bg-white">
      <div></div>
      <div id="footer-total">
        <button class="btn btn-primary" id="btnNext" onclick="window.print()">In Bill</button>
      </div>
    </div>
  </div>
  <div id="list" class="d-none d-flex flex-column" style="height: 100vh;">
    <div id="orderList">
      <div class="d-flex align-items-center p-2 border-bottom bg-white">
        <button class="btnBackHome btn btn-link p-0 me-2">
          <i class="bi bi-arrow-left" style="font-size: 1.5rem;"></i>
        </button>
        <h5 class="mb-0">Theo dõi đơn giặt</h5>
      </div>
      <div id="listAll" style="padding: 10px;">

      </div>
    </div>
    <div id="orderDetail" class="d-none bg-white border rounded shadow-sm">
      <div class="d-flex align-items-center p-2 border-bottom bg-white">
        <button class="btnBacklist btn btn-link p-0 me-2">
          <i class="bi bi-arrow-left" style="font-size: 1.5rem;"></i>
        </button>
        <h5 class="mb-0">Chi tiết đơn giặt</h5>
      </div>
      <div id="detailContent"></div>
    </div>
  </div>
  <div id="ship" class="d-none d-flex flex-column" style="height: 100vh;">
    <div class="d-flex align-items-center p-2 border-bottom bg-white">
      <button class="btnBackHome btn btn-link p-0 me-2">
        <i class="bi bi-arrow-left" style="font-size: 1.5rem;"></i>
      </button>
      <h5 class="mb-0">Theo dõi giao hàng</h5>
    </div>
      <!-- Tabs -->
      <ul class="nav nav-tabs scroll-tabs flex-nowrap" id="tabMenu">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" data-index="0">Tất cả</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-index="1">Đã nhận đơn</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-index="2">Đang giao đơn</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-index="3">Hoàn thành</a></li>
        <li class="nav-item d-none"><a class="nav-link" data-bs-toggle="tab" data-index="4">Hoàn tất</a></li>
      </ul>
    
      <!-- Nội dung (Swiper để vuốt ngang) -->
      <div class="swiper mySwiper">
        <div class="swiper-wrapper">
          <div class="swiper-slide" id="listShipAll"></div>
          <div class="swiper-slide" id="listNew">Nội dung: Chờ vận chuyển</div>
          <div class="swiper-slide" id="listShipping">Nội dung: Đang vận chuyển</div>
          <div class="swiper-slide" id="listIsDone">Nội dung: Cần đánh giá</div>
          <div class="swiper-slide" id="listDone">Nội dung: Hoàn tất</div>
        </div>
      </div>
  </div>
  <!-- Modal -->
  <div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-white text-dark">
        <div class="modal-header border-0">
          <h5 class="modal-title">Đánh giá sản phẩm</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          
          <!-- Rating Stars -->
          <div class="text-center mb-2">
            <span class="star fs-3 text-secondary" data-value="1">★</span>
            <span class="star fs-3 text-secondary" data-value="2">★</span>
            <span class="star fs-3 text-secondary" data-value="3">★</span>
            <span class="star fs-3 text-secondary" data-value="4">★</span>
            <span class="star fs-3 text-secondary" data-value="5">★</span>
            <div id="ratingText" class="mt-1 text-muted">Chọn đánh giá</div>
          </div>
  
          <!-- Tags -->
          <div class="mb-3">
            <button class="btn btn-outline-secondary btn-sm me-1 tag-btn">Đặc điểm</button>
            <button class="btn btn-outline-secondary btn-sm me-1 tag-btn">Chất liệu</button>
            <button class="btn btn-outline-secondary btn-sm me-1 tag-btn">Kích cỡ</button>
          </div>
  
          <!-- Textarea -->
          <div class="mb-2">
            <textarea id="reviewText" class="form-control bg-light text-dark" 
              rows="3" maxlength="300" placeholder="Chia sẻ suy nghĩ của bạn..."></textarea>
            <div class="text-end small mt-1 text-muted"><span id="charCount">0</span>/300</div>
          </div>
  
          <!-- Upload -->
          <div class="mb-3 text-center p-3 border rounded bg-light" id="uploadBox" style="cursor:pointer;">
            <i class="bi bi-camera fs-2 text-secondary"></i><br>
            <span class="text-secondary">Thêm ảnh hoặc video</span>
            <input type="file" id="uploadFile" class="d-none" multiple>
          </div>
  
          <!-- Anonymous -->
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="anonymousCheck">
            <label class="form-check-label" for="anonymousCheck">Đánh giá ẩn danh</label>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button id="submitReview" class="btn w-100" style="background:#ff2e55; color:white;">Gửi</button>
        </div>
      </div>
    </div>
  </div>  
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<script>
  const steps = document.querySelectorAll(".step");
  const labels = document.querySelectorAll(".label");
  const lineFill = document.getElementById("lineFill");
  const contents = document.querySelectorAll(".step-content");
  const btnNext = document.getElementById("btnNext");
  const btnBack = document.getElementById("btnBack");
  let currentStep = 0;
  var itemObj = {};
  var orders = JSON.parse(localStorage.getItem("ListAll")) || [];

  // Đơn giá mẫu (bạn có thể thay đổi theo thực tế)
  const priceList = {
    "Quần áo (Cái)": 25000, // đơn giá mỗi kg
    "Chăn (Cái)": 50000,
    "Khăn (Cái)": 10000,
    "Giày (Đôi)": 50000
  };

  function updateSteps() {
    steps.forEach((step, i) => {
      const circle = step.querySelector(".circle");
      const label = step.querySelector(".label");

      if (i < currentStep) {
        step.classList.add("done");
        step.classList.remove("active");
        circle.innerHTML = '<i class="bi bi-check-lg"></i>';
        label.classList.remove("inactive");
      } else if (i === currentStep) {
        step.classList.add("active");
        step.classList.remove("done");
        circle.textContent = i + 1;
        label.classList.remove("inactive");
      } else {
        step.classList.remove("active", "done");
        circle.textContent = i + 1;
        label.classList.add("inactive");
      }
    });

    const percent = (currentStep / (steps.length - 1)) * 100;
    lineFill.style.width = percent + "%";

    contents.forEach((c, idx) => {
      c.classList.toggle("d-none", idx !== currentStep);
    });

    btnBack.disabled = currentStep === 0;
    btnNext.disabled = currentStep === steps.length - 1;

    // Khi đến bước đơn giá -> render bảng đơn giá
    if (currentStep === 2) {
      renderPriceTable();
    }
  }

  btnNext.addEventListener("click", () => {
    if (currentStep < steps.length - 1) {
      currentStep++;
      updateSteps();
    }
  });

  btnBack.addEventListener("click", () => {
    if (currentStep > 0) {
      currentStep--;
      updateSteps();
    }
  });

  // Bước 2: Cân và phân loại
  const itemType = document.getElementById("itemType");
  const itemQty = document.getElementById("itemQty");
  const itemWeight = document.getElementById("itemWeight");
  const addItemBtn = document.getElementById("addItem");
  const itemTableBody = document.querySelector("#itemTable tbody");

  addItemBtn.addEventListener("click", () => {
    const type = itemType.value.trim();
    const qty = parseInt(itemQty.value);
    const weight = parseFloat(itemWeight.value);

    if (!type || qty <= 0 || weight <= 0) {
      alert("Vui lòng nhập đầy đủ và hợp lệ");
      return;
    }

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${type}</td>
      <td>${qty}</td>
      <td>${weight.toFixed(1)}</td>
      <td class="text-center">
        <button class="btn btn-sm btn-outline-danger delete-item"><i class="bi bi-trash"></i></button>
      </td>
    `;
    itemTableBody.appendChild(row);

    // Reset input
    itemQty.value = 1;
    itemWeight.value = 0.5;
  });

  // Xóa hàng
  itemTableBody.addEventListener("click", (e) => {
    if (e.target.closest(".delete-item")) {
      e.target.closest("tr").remove();
    }
  });

  // Render bảng đơn giá
  function renderPriceTable() {
    const priceTableBody = document.querySelector("#priceTable tbody");
    const totalAmountEl = document.getElementById("totalAmount");

    priceTableBody.innerHTML = "";
    let total = 0;

    document.querySelectorAll("#itemTable tbody tr").forEach(row => {
      const type = row.cells[0].textContent;
      const qty = parseInt(row.cells[1].textContent);
      const weight = parseFloat(row.cells[2].textContent);

      const unitPrice = priceList[type] || 0;
      const amount = unitPrice * weight; // tính theo kg

      total += amount;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${type}</td>
        <td>${weight.toFixed(1)} kg</td>
        <td>${unitPrice.toLocaleString()} đ/kg</td>
        <td>${amount.toLocaleString()} đ</td>
      `;
      priceTableBody.appendChild(tr);
    });

    totalAmountEl.textContent = total.toLocaleString() + " đ";
    renderPaymentStep(total);
    const orderData = createOrderObject(total);
    itemObj = orderData;
    console.log(orderData);
  }

  function renderPaymentStep(totalPriceValue) {
    document.getElementById("total-price").textContent =
    totalPriceValue.toLocaleString() + " VND";

    // Xóa QR cũ (nếu có)
    document.getElementById("qrcode").innerHTML = "";

    // Sinh QR code (giả sử nội dung là link thanh toán Momo hoặc thông tin thanh toán)
    new QRCode(document.getElementById("qrcode"), {
      text: "https://thanhtoan.example.com/?amount=" + totalPriceValue,
      width: 200,
      height: 200
    });
  }

  var swiper = new Swiper(".mySwiper", {
    spaceBetween: 0,
    on: {
      slideChange: function () {
        let index = this.activeIndex;
        $("#tabMenu .nav-link").removeClass("active");
        $('#tabMenu .nav-link[data-index="'+index+'"]').addClass("active");
        scrollTabToCenter($('#tabMenu .nav-link[data-index="'+index+'"]'));
      }
    }
  });

  // Click tab -> chuyển slide
  $("#tabMenu .nav-link").on("click", function () {
    let index = $(this).data("index");
    swiper.slideTo(index);
  });

  // Auto scroll tab vào giữa
  function scrollTabToCenter($item) {
    let $container = $("#tabMenu");
    let containerWidth = $container.width();
    let itemPos = $item.position().left + $container.scrollLeft();
    let itemWidth = $item.outerWidth();
    let scrollPos = itemPos - (containerWidth / 2) + (itemWidth / 2);
    $container.animate({ scrollLeft: scrollPos }, 300);
  }

  function openApp(appName) {
    if(appName === 'giat') {

      document.getElementById("create").classList.remove("d-none");
      document.getElementById("all").classList.add("d-none");
    } else if(appName === 'check'){
      createListOrder();
      document.getElementById("list").classList.remove("d-none");
      document.getElementById("all").classList.add("d-none");
    } else if(appName === 'ship'){
      renderListOrder();
      document.getElementById("ship").classList.remove("d-none");
      document.getElementById("all").classList.add("d-none");
    } else {
      alert('Mở ứng dụng: ' + appName);
    }
  }

  $(".btnBackHome").click(() => {
    document.getElementById("list").classList.add("d-none");
    document.getElementById("create").classList.add("d-none");
    document.getElementById("ship").classList.add("d-none");
    document.getElementById("all").classList.remove("d-none");
  })
  $(".btnBacklist").click(() => {
    document.getElementById("orderList").classList.remove("d-none");
    document.getElementById("orderDetail").classList.add("d-none");
  })
  $(".btnBackCreate").click(() => {
    document.getElementById("bill-view").classList.add("d-none");
    document.getElementById("create").classList.remove("d-none");
  })
  $("#success").click(() => {
    let ListAll = JSON.parse(localStorage.getItem("ListAll")) || [];
    ListAll.push(itemObj);
    orders = ListAll;
    localStorage.setItem("ListAll", JSON.stringify(ListAll));

    document.getElementById("create").classList.add("d-none");
    document.getElementById("all").classList.remove("d-none");
    toastr.success("Tạo đơn giặt thành công.");
  })

  $("#create-bill").click(() => {
    document.getElementById("create").classList.add("d-none");
    document.getElementById("bill-view").classList.remove("d-none");
    showBill()
  })

  function createOrderObject(total) {
    // Lấy thông tin từ form
    const order = {
        customerName: document.querySelector('input[placeholder="Nhập tên khách hàng"]').value.trim(),
        address: document.querySelector('input[placeholder="Nhập địa chỉ"]').value.trim(),
        phone: document.querySelector('input[placeholder="Nhập số điện thoại"]').value.trim(),
        washType: document.querySelectorAll('select')[0].value, // Loại giặt
        machineWash: document.querySelectorAll('select')[1].value, // Máy giặt
        machineDry: document.querySelectorAll('select')[2].value,  // Máy sấy
        estimatedTime: document.querySelector('input[placeholder="Giặt trong 50 phút"]').value.trim(),
        washTurn: document.querySelector('input[placeholder="Lượt 1"]').value.trim(),
        totalAmount: total,
        items: [],
        status: 'NEW',
        createdAt: new Date().toLocaleString()
    };

    // Lấy danh sách sản phẩm từ bảng #itemTable
    document.querySelectorAll("#itemTable tbody tr").forEach(row => {
        const type = row.cells[0].textContent;
        const qty = parseInt(row.cells[1].textContent);
        const weight = parseFloat(row.cells[2].textContent);

        const unitPrice = priceList[type] || 0;
        const amount = unitPrice * weight; // tính theo kg

        order.items.push({
            type,
            qty,
            weight,
            amount
        });
    });

    return order;
  }

  function createListOrder() {
    let listAllContainer = document.getElementById("listAll");
    listAllContainer.innerHTML = "";

    // Hiển thị rút gọn
    orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach((order, index) => {
        let orderHTML = `
            <div class=" card mb-2 order-item" data-index="${index}">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">${order.createdAt || "Chưa có thời gian"}</div>
                        <small class="text-muted">${order.status}</small>
                    </div>
                    <div class="fw-bold text-primary">
                        ${order.totalAmount.toLocaleString()} đ
                    </div>
                </div>
            </div>
        `;
        listAllContainer.innerHTML += orderHTML;
    });

    document.querySelectorAll(".order-item").forEach(el => {
      el.addEventListener("click", function(){
          let index = this.getAttribute("data-index");
          let o = orders[index];

          // Ẩn danh sách, hiện chi tiết
          document.getElementById("orderList").classList.add("d-none");
          document.getElementById("orderDetail").classList.remove("d-none");

          // Render chi tiết
          document.getElementById("detailContent").innerHTML = `
  <div class="p-3">
    <p><strong>Thời gian:</strong> ${o.createdAt}</p>
    <p><strong>Trạng thái:</strong> <span class="badge bg-info text-dark">${o.status}</span></p>
    <p><strong>Khách hàng:</strong> ${o.customerName}</p>
    <p><strong>Địa chỉ:</strong> ${o.address}</p>
    <p><strong>Số điện thoại:</strong> ${o.phone}</p>
    <p><strong>Loại giặt:</strong> ${o.washType}</p>
    <p><strong>Máy giặt:</strong> ${o.machineWash}</p>
    <p><strong>Máy sấy:</strong> ${o.machineDry}</p>
    <h5 class="mt-3 text-primary">Tổng tiền: ${o.totalAmount.toLocaleString()} đ</h5>
    <hr>
    <h6 class="mb-3">Danh sách đồ:</h6>
    <div class="table-responsive">
      <table class="table table-sm table-bordered">
        <thead class="table-light">
          <tr>
            <th>STT</th>
            <th>Loại</th>
            <th>Số lượng</th>
            <th>Khối lượng (kg)</th>
          </tr>
        </thead>
        <tbody>
          ${o.items.map((item, index) => `
            <tr>
              <td>${index + 1}</td>
              <td>${item.type}</td>
              <td>${item.qty}</td>
              <td>${item.weight}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  </div>
`;

      });
  });

  // Nút quay lại
  document.getElementById("btnBack").addEventListener("click", function(){
      document.getElementById("orderDetail").classList.add("d-none");
      document.getElementById("orderList").classList.remove("d-none");
  });
  }

  function renderListOrder() {
    let containers = {
      all: document.getElementById("listShipAll"),
      new: document.getElementById("listNew"),
      inprogress: document.getElementById("listShipping"),
      done: document.getElementById("listDone"),
      isDone: document.getElementById("listIsDone")
    };

    Object.values(containers).forEach(c => c.innerHTML = "");

    orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
      .forEach((order, index) => {
        let baseHTML = `
          <div class="card mb-2 order-item" data-index="${index}">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-bold">${order.createdAt || "Chưa có thời gian"}</div>
                  <small class="text-muted">${order.status}</small>
                </div>
                <div class="fw-bold text-primary">
                  ${order.totalAmount.toLocaleString()} đ
                </div>
              </div>
        `;

        if (order.status === "ISDONE") {
          baseHTML += `
            <div class="mt-2" style="display: flex; justify-content: end;">
              <button class="btn btn-sm review-btn" data-index="${index}" style="background-color: #f54646; color: white;">
                Viết đánh giá
              </button>
            </div>
          `;
        }

        baseHTML += `</div></div>`;

        containers.all.innerHTML += baseHTML;
        if (order.status === "NEW") containers.new.innerHTML += baseHTML;
        if (order.status === "INPROGRESS") containers.inprogress.innerHTML += baseHTML;
        if (order.status === "ISDONE") containers.isDone.innerHTML += baseHTML;
      });

    // Gán sự kiện mở modal cho nút "Đánh giá"
    document.querySelectorAll(".review-btn").forEach(btn => {
      btn.addEventListener("click", function () {
        let orderIndex = this.getAttribute("data-index");

        // reset modal trước
        document.querySelectorAll("#reviewModal .star").forEach(s => s.classList.remove("active"));
        document.getElementById("ratingText").innerText = "Chọn đánh giá";
        document.getElementById("reviewText").value = "";
        document.getElementById("charCount").innerText = "0";
        document.querySelectorAll(".tag-btn").forEach(t => t.classList.remove("active"));
        document.getElementById("anonymousCheck").checked = false;
        document.getElementById("uploadFile").value = "";

        // mở modal
        let modal = new bootstrap.Modal(document.getElementById('reviewModal'));
        modal.show();

        // click sao trong modal
        document.querySelectorAll("#reviewModal .star").forEach(star => {
          star.onclick = function () {
            let value = parseInt(this.getAttribute("data-value"));

            // reset tất cả sao về xám
            document.querySelectorAll("#reviewModal .star").forEach(s => {
              s.classList.remove("text-warning");
              s.classList.add("text-secondary");
            });

            // tô vàng từ 1 -> value
            for (let i = 0; i < value; i++) {
              document.querySelectorAll("#reviewModal .star")[i].classList.remove("text-secondary");
              document.querySelectorAll("#reviewModal .star")[i].classList.add("text-warning");
            }

            // đổi text hiển thị
            const texts = ["Rất tệ", "Tệ", "Bình thường", "Tốt", "Xuất sắc"];
            document.getElementById("ratingText").innerText = texts[value - 1] || "Chọn đánh giá";

            // lưu rating vào modal
            document.getElementById("reviewModal").setAttribute("data-rating", value);
          };
        });

        // đếm ký tự textarea
        document.getElementById("reviewText").oninput = function () {
          document.getElementById("charCount").innerText = this.value.length;
        };

        // chọn tag
        document.querySelectorAll(".tag-btn").forEach(tag => {
          tag.onclick = function () {
            this.classList.toggle("active");
          };
        });

        // click vào upload box
        document.getElementById("uploadBox").onclick = function () {
          document.getElementById("uploadFile").click();
        };

        // submit review
        document.getElementById("submitReview").onclick = () => {
          let rating = document.getElementById("reviewModal").getAttribute("data-rating") || 0;
          let text = document.getElementById("reviewText").value;
          let tags = Array.from(document.querySelectorAll(".tag-btn.active")).map(t => t.innerText);
          let anonymous = document.getElementById("anonymousCheck").checked;
          let files = document.getElementById("uploadFile").files;

          alert(`
            Đánh giá đơn hàng #${orderIndex}
            Sao: ${rating}
            Nội dung: ${text}
            Tag: ${tags.join(", ")}
            Ẩn danh: ${anonymous}
            Số file upload: ${files.length}
          `);

          modal.hide();
        };
      });
    });
  }

  function showBill() {

  // Fill data
  document.getElementById('bill-customerName').textContent = itemObj.customerName;
  document.getElementById('bill-phone').textContent = itemObj.phone;

  const date = new Date(itemObj.createdAt);
  document.getElementById('bill-date').textContent = date.toLocaleDateString('vi-VN');
  document.getElementById('bill-time').textContent = date.toLocaleTimeString('vi-VN');

  let totalWeight = 0;
  let html = '';
  itemObj.items.forEach(i => {
    totalWeight += i.weight;
    html += `<tr>
      <td>${i.type}</td>
      <td>${i.qty}</td>
      <td>${i.weight}</td>
      <td>${i.amount.toLocaleString()}</td>
    </tr>`;
  });
  document.getElementById('bill-weight').textContent = totalWeight + " kg";
  document.getElementById('bill-items').innerHTML = html;
  document.getElementById('bill-total').textContent = itemObj.items.reduce((sum, i) => sum + i.amount, 0).toLocaleString();

  document.getElementById("qrcodeZalo").innerHTML = "";

    // Sinh QR code (giả sử nội dung là link thanh toán Momo hoặc thông tin thanh toán)
  new QRCode(document.getElementById("qrcodeZalo"), {
    text: "https://zalo.me/s/4560528012046048397/",
    width: 100,
    height: 100
  });
}

  function closeBill() {
    document.getElementById('billView').style.display = 'none';
  }

  updateSteps();
</script>

</body>
</html>
